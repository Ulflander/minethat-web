var util=require("util"),Twitter=require("twitter"),moment=require("moment"),Entities=require("html-entities").AllHtmlEntities,entities=new Entities,twit=new Twitter({consumer_key:"WO30xPwtmdSOzOmoJ5ruAdeHH",consumer_secret:"IH6UltER7AQsA9Y3vUCDGJxi3AKS4NbzcXDICwBGergu3wJKvm",access_token_key:"58438762-2U1PaQyuvH9DIxcNU40rKxzjmz1klqYSzOlTY8tVk",access_token_secret:"ZGZF2dsQLshYautCNjuxbO7lM6gzRYJVEISDBrc07Kxep"});
(function(c){var b,a,h,g,f=require("./lib/internet.js"),e=0;require("./conf.js").conf(function(d){b=d.logger;a=require("./lib/models.js");g=require("./lib/job.js");h=a.model("Source");setInterval(c.update,"local"===d.env?5E3:1E3);b.log("Aggregator started...");g.init(c.update)});c.markError=function(d,a){d.successive_errors||(d.successive_errors=0);d.successive_errors+=1;h.update({_id:d._id},{successive_errors:d.successive_errors,last_error:a?a.toString():""},function(d,a,k){d?b.error("Error updating source",
d):0===a&&b.error("Error updating source: no item affected")})};c.getLinkField=function(d){if("string"===typeof d.origlink)return d.origlink;if(Array.isArray(d.origlink))return d.origlink[0];if("string"===typeof d.link)return d.link;if(Array.isArray(d.link))return d.link[0]};c.getTitleField=function(d){var a="";"string"===typeof d.title&&(a=d.title);Array.isArray(d.title)&&(a=d.title[0]);return entities.decode(a.replace(/(<([^>]+)>)/ig," "))};c.getDescField=function(d){var a="";"string"===typeof d.description&&
(a=d.description);Array.isArray(d.description)&&(a=d.description[0]);"string"===typeof d.desc&&(a=d.desc);Array.isArray(d.desc)&&(a=d.desc[0]);return entities.decode(a.replace(/(<([^>]+)>)/ig," "))};c.submit=function(d,a){var e;c.getLinkField(a)&&(e={customerId:"2c7f9a",gateway:"API",status:"VOID",type:"FEED_URL",value:c.getLinkField(a),meta:{doc_description_quality:d.quality,doc_title:c.getTitleField(a),doc_published_date:a.date,doc_description:c.getDescField(a),doc_source_name:d.name,doc_source_url:d.url,
doc_source_id:d._id,doc_source_feed_url:d.feed_url}},g.makeup(e,function(a){a?(b.warn("Unable to publish job for "+d.name),c.markError(d,a)):b.debug("Job published for "+d.name)}))};c.aggregate=function(d,a){f.feed(d.feed_url,function(e,f){if(e)b.warn("Unable to retrieve feed items: "+d.name,e),c.markError(d,e);else{var h=f.items,g,p=0,r=!1,m,s=h.length;for(g=0;g<s;g+=1)m=h[g].date,isNaN(m)&&(m=moment(m).valueOf()),"string"===typeof m||isNaN(m)||0===m?(b.warn("Feed article date is not valid"),c.markError(d)):
m>(d.last||0)&&(h[g].date=m,c.submit(d,h[g]),r=!0,m>p&&(p=m));0===p&&!1!==r?(b.warn("Unable to retrieve feed items: "+d.name),c.markError(d)):(0<p&&(d.last=p),a(d))}})};c.check=function(d){c.aggregate(d,function(d){h.update({_id:d._id},{last:d.last,successive_errors:0},function(d,a,c){d?b.error("Error updating source",d):0===a&&b.error("Error updating source: no item affected")})})};c.update=function(){h.find({$or:[{successive_errors:{$lt:10}},{successive_errors:{$exists:!1}}]},{},{skip:e,limit:1},
function(d,a){if(d)b.error("Error querying db",d);else{var g,f=a.length;if(0===f)b.log("No source found"),e=0;else for(e+=1,g=0;g<f;g+=1)c.check(a[g])}})}})(exports);(function(c){var b=process.env.ENV,a,h=require("fs"),g=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(d){5===d.level?console.error(d.output):console.log(d.output)}}),f=!1,e={loaded:!1,logger:g,env:b};"string"!==typeof b&&(g.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));a=__dirname+"/../../../conf/conf."+b+".sh";
c.parseLine=function(d){0!==d.indexOf("#")&&0<d.indexOf("=")&&(d=d.split("="),e[d[0].trim()]=/^[0-9]+$/ig.test(d[1])?parseInt(d[1],10):d[1].trim())};c.parse=function(d){d=d.split("\n");var a,b=d.length;for(a=0;a<b;a+=1)c.parseLine(d[a])};c.read=function(d){f=!0;h.realpath(a,function(b,n){b&&(g.error("No way to solve path "+a,b),process.exit(1));g.log("Loading configuration at "+n);h.readFile(n,function(a,b){a&&(g.error("No way to load conf",a),process.exit(1));c.parse(b.toString());h.realpath(__dirname+
"/../../",function(a,b){a&&(g.error("No way to get root path",a),process.exit(1));e.root=b;f=!1;e.loaded=!0;g.log("Configuration loaded ...");"function"===typeof d&&d(e)})})});return e};c.wait=function(d){setTimeout(function(){e.loaded?d(e):c.wait(d)},15)};c.conf=function(d){if(e.loaded)return"function"===typeof d&&d(e),e;if(!f)return c.read(d);"function"===typeof d&&c.wait(d);return e}})(exports);(function(){require("./conf.js").conf(function(c){require("./server.js").run(c)})})();(function(c){var b=require("connect"),a=require("serve-static"),h=require("body-parser"),g=require("./lib/blog.js"),f=require("./lib/init.js").initialize,e=require("./routes/router.js").router,d=require("./lib/job.js"),k=require("./controllers/404.js");c.run=function(c){var l=b();l.conf=c;l.logger=c.logger;d.init();g.init(function(){l.use(require("./lib/auth.js").auth);l.use(a(c.WEB_SERVER_STATIC_PATH||__dirname+"/../../dist"));l.use(h({limit:"10mb"}));l.use(f);l.use(e());l.use(k.index);l.listen(c.WEB_SERVER_PORT);
l.logger.log("Server started on "+c.WEB_SERVER_HOST+":"+c.WEB_SERVER_PORT)})}})(exports);(function(c){var b=require("../lib/controller-view.js");c.index=function(a,c,g){a.logger.warn("Page not found: ["+a.method+"] "+a.url);b.view(a,c,"404.html",{value:1E3,url:null},404)}})(exports);(function(){var c=require("../lib/controller-view.js"),b=/<p>([^<]+)/im,a={},h={};exports.add=function(c,f){a[c]=f;var e=b.exec(f);h[c]=e?e[1].split("\n").join(" "):""};exports.index=function(b,f,e){e=[];var d,k;for(d in a)a.hasOwnProperty(d)&&(k=d.split("/devlog/").join("").split(".html").join("").split("-"),e.unshift({url:"/devlog/"+k.join("-")+".html",date:k.splice(0,3).join("/"),title:k.join(" ")}));c.view(b,f,"blog/articles.html",{articles:e})};exports.article=function(b,f,e){e=b.url.split("/devlog/").join("").split(".html").join("").split("-");
c.view(b,f,"blog/article.html",{summary:h[b.url],url:"http://www.minethat.co"+b.url,content:a[b.url]||"Article not found",date:e.splice(0,3).join("/"),title:e.join(" ")})}})();(function(){var c=require("../lib/controller-view.js");exports.index=function(b,a,h){c.findAll(b,a,"Document",null,null,{sort:{"properties.meta.doc_aggregated_date":-1},limit:50},"document/list.html")};exports.recent=function(b,a,h){if(!b.isAPI)return h();c.findAll(b,a,"Document",{status:"MINED"},"properties.meta",{sort:{"properties.meta.doc_aggregated_date":-1},limit:10})};exports.display=function(b,a,h){c.find(b,a,"Document","document/display.html")};exports.export_bunch=function(b,a,h){c.findAll(b,
a,"Document",{status:"MINED"},null,{sort:{"properties.meta.doc_aggregated_date":-1},limit:100})};exports.remove=function(b,a,h){c.remove(b,a,"Document")};exports.search=function(b,a,h){h={status:"MINED"};a._data={search:null};"POST"===b.method&&(h["properties.keywords.main"]=b.body.keywords);c.findAll(b,a,"Document",h,null,{sort:{"properties.meta.doc_aggregated_date":-1}},"document/search.html")}})();(function(){var c=require("../lib/controller-view.js"),b=require("../lib/filter-utils");exports.create=function(a,h,g){"GET"===a.method?c.view(a,h,"filter/edit.html"):(a.body=b.toFilterModel(a.body),console.log(a.body),c.create(a,h,"Filter","filter/edit.html","/app/filters/:id"))};exports.edit=function(a,h,g){"POST"===a.method&&(a.body=b.toFilterModel(a.body));c.edit(a,h,"Filter","filter/edit.html")};exports.estimate=function(a,h,g){var f=b.toCondition(a.body);exports.countWeeks(a,f,[],function(b,
d){var k,g=d.length,l=0;if(b)a.logger.warn("Unable to get counts per week",b);else{for(k=0;k<g;k+=1)l+=d[k];h.global.avg_per_week=(l/g).toFixed(0);h.global.count_per_week=d}delete f["properties.meta.doc_published_date"];c.findAll(a,h,"Document",f,null,{sort:{"properties.meta.doc_published_date":-1}},"filter/estimation.html")})};exports.wall=function(a,h,g){a.find("Filter",a.params.id,function(f,e){if(f||!e)return f&&console.error("Unable to find filter",f),g();c.findAll(a,h,"Document",b.toCondition(e.fields),
null,{sort:{"properties.meta.published_date":-1}},"filter/wall.html")})};exports.remove=function(a,b,g){c.remove(a,b,"Filter")};exports.countWeeks=function(a,b,c,f){var e=c.length,d=Date.now()-6048E5*e,k=Date.now()-6048E5*(e+1);4===e?f(null,c.reverse()):(b["properties.meta.doc_published_date"]={$gt:k,$lte:d},a.model("Document").count(b,function(d,k){if(d)return f(d);c[e]=k;exports.countWeeks(a,b,c,f)}))}})();(function(){var c=require("../lib/controller-view.js"),b=require("../lib/valid.js"),a=require("../lib/mail.js"),h=require("url"),g=require("ua-parser-js"),f=require("../routes/campaigns.js").campaigns;exports.campaign=function(a){var d={ref_campaign:"None",ref_domain:"Unknown"};a.query&&a.query.r&&(d.ref_campaign=f[a.query.r]||a.query.r);a.headers.referer&&(d.ref_domain=h.parse(a.headers.referer).hostname,0===d.ref_domain.indexOf("www.")&&(d.ref_domain=d.ref_domain.substr(4)));return d};exports.index=
function(a,d,b){c.view(a,d,"landing/landing.html",exports.campaign(a))};exports.subscribe=function(a,d,c){c=a.model("Subscriber");if(!a.body||!a.body.email)return d.json({error:"miss_param"},500);if(!b.email(a.body.email))return d.json({error:"invalid_email"},500);c.findOne({email:a.body.email},function(b,c){if(b)return d.json({error:"db_check_failed"},500);if(c)return d.json({status:"exists",id:c._id},200);exports.create(a,d)})};exports.create=function(b,d){var c=b.model("Subscriber"),f=(new g).setUA(b.headers["user-agent"]).getResult()||
{},h=new c({email:b.body.email,ref_campaign:b.body.ref_campaign,ref_domain:b.body.ref_domain,browser:f.browser&&f.browser.name?f.browser.name:"Unknown",os:f.os&&f.os.name?f.os.name:"Unknown",device:f.device&&f.device.vendor?f.device.vendor+" / "+(f.device.model||"Unknown"):"Unknown"});h.save(function(c){if(c)return d.json({error:"db_save_failed"},500);a.template(b.body.email,"You're in!","landing-subscribed.html",{sub:h});a.template("xav@minethat.co","He's in!","landing-subscribed-alert.html",{sub:h});
d.json({status:"success"})})}})();(function(){var c=require("../lib/controller-view.js");exports.index=function(b,a,h){c.findAll(b,a,"Job",null,null,null,"job/list.html")};exports.remove=function(b,a,h){c.remove(b,a,"Job")}})();(function(){var c=require("../lib/controller-view.js"),b=require("../lib/internet.js");exports.index=function(a,b,g){c.findAll(a,b,"Source",null,null,null,"source/list.html")};exports.display=function(a,b,g){c.find(a,b,"Source","source/edit.html")};exports.from_feed=function(a,h,g){"GET"===a.method?!1===a.isAPI?c.view(a,h,"source/from_feed.html"):h.json({status:"error",error:"Unauthorized method"},401):b.feed(a.body.feed_url,function(b,e,d){if(!b&&e&&d){var k;console.log(e.metadata);"string"===typeof e.metadata.url?
k=e.metadata.url:Array.isArray(e.metadata.url)?(b=e.metadata.url[0],"string"===typeof b?k=b:b.href&&(k=b.href)):a.logger.warn("Unable to detect site url for feed",e.metadata);a.body.name=e.metadata.title;a.body.url=k;exports.add(a,h,g)}else!1===a.isAPI?c.view(a,h,"source/from_feed.html",{error:"Invalid feed"}):h.json({status:"error",error:"Invalid feed"},422)})};exports.add=function(a,b,g){c.create(a,b,"Source","source/edit.html","/app/source/:id")};exports.edit=function(a,b,g){c.edit(a,b,"Source",
"source/edit.html")};exports.check=function(a,c,g){b.feed(a.body.feed_url,function(b,e){b||!e?c.json({status:"error",error:"Invalid feed"},422):a.findAll(a,"Source",{feed_url:a.body.feed_url},null,null,function(d,a){d?c.json({status:"error",error:"Internal error"},500):0===a.total?c.json({status:"success"},200):c.json({status:"exists"},409)})})};exports.remove=function(a,b,g){c.remove(a,b,"Source")}})();(function(){var c=require("../lib/job.js");exports.html_string=function(b,a,c){if(!b.body.content)return a.json({status:"error",error:'Missing "content" parameter'},500);exports.submit(b,a,"HTML_STRING",b.body.content)};exports.string=function(b,a,c){if(!b.body||!b.body.string)return a.json({status:"error",error:'Missing "string" parameter'},500);exports.submit(b,a,"STRING",b.body.string)};exports.url=function(b,a,c){if(!b.body||!b.body.url)return a.json({status:"error",error:'Missing "url" parameter'},
500);exports.submit(b,a,"URL",b.body.url)};exports.submit=function(b,a,h,g){console.log("[API] Got request");var f={customerId:"2c7f9a",gateway:"API",status:"VOID",type:h,value:g};b.body.meta&&(f.meta=b.body.meta);if(b.body.target&&"TRAIN"===b.body.target){if(!b.body||!b.body.classes)return a.json({status:"error",error:'Missing "classes" parameter'},500);f.target="TRAIN";f.classes=b.body.classes}c.makeup(f,function(b){return b?a.json({status:"error",error:"DB error"},500):a.json({status:"success",
job:f._id})})}})();(function(){var c=require("../lib/controller-view.js");exports.index=function(b,a,h){c.findAll(b,a,"Subscriber",null,null,null,"subscriber/list.html")};exports.display=function(b,a,h){c.find(b,a,"Subscriber","subscriber/display.html")};exports.csv=function(b,a,h){c.find(b,a,"Subscriber","subscriber/display.html")}})();(function(){var c=require("../lib/controller-view.js");exports.index=function(b,a){var h=b.model("Subscriber");if(!b.query.id)return a.error("Missing param for unsubscription",500);h.findById(b.query.id,function(g,f){var e=null;if(g)return a.error("DB query error",500);b.query.action&&("unsubscribe"===b.query.action?(f.unactivated=!0,e="Done! You won't receive our newsletter anymore."):(f.unactivated=!1,e="Thanks! You're now subscribed to our newsletter!"),f.save());c.view(b,a,"subscriber/subscription.html",
{msg:e,sub:f})})}})();(function(){var c=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(b,a,h){0===b._parsedUrl.href.indexOf("/private")||0===b._parsedUrl.href.indexOf("/admin")||0===b._parsedUrl.href.indexOf("/app")?c.check(b,a,function(a){h()}):h()}})();(function(){var c=require("fs"),b=require("../routes/routes.js"),a=require("../controllers/blog.js"),h=require("marked"),g=require("../conf.js").conf();exports.add=function(f){if("."!==f.substring(0,1)||"local"===g.env){var e=f.split(".md").join("");b.add("/devlog/"+e+".html",["get","blog.article"]);c.readFile(g.root+"/src/blog/"+f,function(d,b){d?g.logger.error("Unable to read blog article"+g.root+"/src/blog/"+f,d):h(b.toString(),{},function(d,b){d?g.logger.error("Unable to convert blog article"+
g.root+"/src/blog/"+f,d):a.add("/devlog/"+e+".html",b)})})}};exports.init=function(a){c.readdir(g.root+"/src/blog/",function(b,d){if(b)g.logger.error('Blog files not found at "'+g.root+'/src/blog/"',b);else{var c,h=d.length;for(c=0;c<h;c+=1)-1<d[c].indexOf(".md")&&exports.add(d[c]);"function"===typeof a&&a()}})}})();(function(){var c=require("ejs"),b=require("fs"),a=require("async"),h=require("../conf.js").conf(),g=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,f={},e={leadingZero:function(d){return 10>d?"0"+d:d},tsToReadable:function(d){d=new Date(d);return d.getMonth()+1+"/"+d.getDate()+"/"+d.getUTCFullYear()+", "+e.leadingZero(d.getHours())+":"+e.leadingZero(d.getMinutes())}};exports.remove=function(d,a,b,c){d.isAPI?d.model(b).findById(d.params.id,function(d,b){d||null===b?a.json({status:"error",error:"Resource not found"},
404):b.remove(function(d){d?a.json({status:"error",error:"Resource not deleted"},500):a.json({status:"success"},200)})}):a.error(404,"Only available through API")};exports.save=function(d,a,b,c,f){var e=new (d.model(b))(d.body),g=!1;e.save(function(b){var h={status:b?"error":"success",doc:e.toObject()};g||(g=!0,b&&(h.error={message:b}),d.isAPI?a.json(h,b?500:200):f?a.redirect(f.split(":id").join(e._id)):exports.view(d,a,c,h))})};exports.create=function(d,a,b,c,f){var e=d.model(b);"POST"===d.method?
exports.save(d,a,b,c,f):d.isAPI?a.json({error:"Not implemented"},500):exports.view(d,a,c,{doc:new e,status:"create"})};exports.find=function(d,a,b,c){d.find(b,d.params.id,function(b,f){if(b)return d.logger.warn("Error caught while querying db",b),a.error(500);f?d.isAPI?a.json(f.toObject()):exports.view(d,a,c,{doc:f,status:"exists"}):d.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})};exports.edit=function(a,b,c,f){"GET"===a.method?exports.find(a,b,c,f):a.model(c).update({_id:a.params.id},
a.body,function(e,g,h){if(e)return a.logger.warn("Error caught while querying db",e),b.error(500);a.find(c,a.params.id,function(c,e){if(c)return b.error(500);e?a.isAPI?b.json(e):exports.view(a,b,f,{doc:e,status:"exists"}):a.isAPI?b.json({status:"error",error:"Resource not found"},404):b.error(404)})})};exports.findAll=function(a,b,c,f,e,g,h){a.findAll(a,c,f,e,g,function(c,f){if(c)return b.error(404);a.isAPI?b.json(f):exports.view(a,b,h,f)})};exports.requiresLoading=function(a){return!f[a]||"local"===
h.env};exports.load=function(a,c){b.readFile(__dirname+"/../views/"+a,function(b,e){b?(h.logger.error("File not found: views/"+a),f[a]="Template not found"):f[a]=e.toString();var g=exports.detectPartials(a);0<g.length?exports.loadPartials(g,c):"function"===typeof c&&c()})};exports.render=function(a,b){try{return c.render(f[a],{data:b?b:{},partial:exports.partial,env:h.env,utils:e})}catch(g){return h.logger.error("Unable to render template",g),null}};exports.view=function(a,b,c,f,e){var g;f||(f={});
if(b.global)for(g in b.global)b.global.hasOwnProperty(g)&&(f[g]=b.global[g]);exports.renderView(c,f,function(a){b.html(a,e)})};exports.renderView=function(a,b,c){var f=function(){c(exports.render(a,b))};if(exports.requiresLoading(a))return exports.load(a,f);f()};exports.partial=function(a,b){var g={data:b};g.env=h.env;g.partial=exports.partial;g.utils=e;return c.render(f["_partials/"+a+".html"],g)};exports.loadPartials=function(b,c){var f,e=b.length,g=[];for(f=0;f<e;f+=1)g.push(exports.loadPartial(b[f]));
a.parallel(g,c)};exports.loadPartial=function(a){return function(b){exports.load("_partials/"+a+".html",b)}};exports.detectPartials=function(a){for(var b=[],c;;){c=g.exec(f[a]);if(!c)break;b.push(c[1])}return b}})();(function(){exports.toFilterModel=function(c){var b={fields:{}},a;for(a in c)if(c.hasOwnProperty(a))switch(a){case "name":case "color":b[a]=c[a];break;default:b.fields[a.replace(/\./ig,"/")]=c[a]}return b};exports.toCondition=function(c){var b={status:"MINED"},a;for(a in c)c.hasOwnProperty(a)&&exports.toFieldCondition(b,a,c[a]);return b};exports.toFieldCondition=function(c,b,a){switch(b){case "keywords":if(""===a)break;c["properties.keywords.main"]={$in:a.split(",")};break;case "entities":break;default:exports.toFieldMetric(c,
b,a)}};exports.toFieldMetric=function(c,b,a){var h;b=b.replace(/\//ig,".");-1!==b.indexOf(".")&&(b=b.split("."),h=b.splice(b.length-1,1)[0],"min"===h||"max"===h)&&(a=parseFloat(a),isNaN(a)||(b=b.join("."),c[b]||(c[b]={}),"min"===h?c[b].$gte=a:c[b].$lte=a))}})();(function(c){var b=require("../conf.js").conf(),a=require("./respond.js"),h=require("./models.js"),g=require("qs");c.initialize=function(c,e,d){var k;e.global={};c.logger=b.logger;c.query=g.parse(c._parsedUrl.query);for(k in h)h.hasOwnProperty(k)&&(c[k]?b.logger.error("Injection failed: key "+k+"already defined in Request object"):c[k]=h[k]);for(k in a)a.hasOwnProperty(k)&&(e[k]?b.logger.error("Injection failed: key "+k+"already defined in Response object"):e[k]=a[k]);0===c._parsedUrl.href.indexOf("/app")?
c.findAll(null,"Filter",null,null,null,function(a,b){e.global.customer_filters=b.docs;d()}):d()}})(exports);(function(c){var b=require("request"),a=require("../conf.js").conf().logger,h=require("ortoo-feedparser"),g=require("blindparser");c.get=function(c,e,d){try{b({url:c,followAllRedirects:!0,headers:d||{}},function(b,d){!b&&200<=d.statusCode&&300>d.statusCode?e(null,d.body):(a.warn("URL is invalid: "+b,d?d.statusCode:d,c),e(b))})}catch(g){a.warn("URL is invalid",c,g),e(g)}};c.feed=function(b,e,d){var k={Accept:"text/xml,application/xml,application/rss+xml","Accept-Language":"*","User-Agent":"Minethat 1.0"};
d&&(k["If-Modified-Since"]=d);c.get(b,function(c,d){if(c)e(c);else try{g.parseString(d,{},function(c,d){c?(a.warn("URL "+b+" feed is invalid: "+c),e(c)):e(null,d,b)})}catch(k){a.log("Fallback to feedparser..."),h.parseString(d,{},function(a,c,d){a&&e(a);e(null,{meta:c,items:d},b)})}},k)}})(exports);(function(){var c=require("amqp"),b=require("../conf.js").conf(),a=!1,h=require("./models.js"),g;exports.init=function(f){g=c.createConnection({host:b.RABBIT_HOST,port:b.RABBIT_PORT});g.on("ready",function(){b.logger.log("[RabbitMQ] Connection established");g.queue(b.RABBIT_EXTRACT_QUEUE,{durable:!0,exclusive:!1,autoDelete:!1},function(b){console.log("[RabbitMQ] Queue declared");a=!0;"function"===typeof f&&(f(),f=null)})});g.on("error",function(){a=!1;console.log("[RabbitMQ] Error",arguments)})};
exports.makeup=function(a,b){var c=new (h.model("Job"))(a);c.save(function(a){a||exports.publish(c._id);"function"===typeof b&&b(a,c)})};exports.publish=function(c){a?(b.logger.log("[RabbitMQ] Submitted job "+c),g.publish("extract",c)):setTimeout(function(){exports.publish(c)},100)}})();(function(){module.exports=function(c,b){if(c===b)return 0;var a=c.length,h=b.length,g=0,f=0,e,d,k,n,l=[];if(a&&h){for(;g<a;)g+=1,l[g]=g;for(;f<h;)for(n=b.charCodeAt(f),e=f,d=f+=1,g=0;g<a;g+=1)k=e+(c.charCodeAt(g)===n?0:1),e=l[g],d=d<e?d<k?d+1:k:e<k?e+1:k,l[g]=d;return d}return a+h}})();(function(){var c,b=require("html-to-text"),a=require("./controller-view.js"),h=require("../conf.js").conf(),g=h.logger,f=require("nodemailer");exports.html=function(a,d,k,n,l){c||(c=f.createTransport("SMTP",{service:"Gmail",auth:{user:h.WEB_EMAIL_USER,pass:h.WEB_EMAIL_PASS}}));g.debug("Sending message to: "+a+" (Subject: "+d+")");c.sendMail({from:n||"Xav from Minethat <xav@minethat.co>",to:a,subject:d,text:l||b.fromString(k),html:k},function(b,c){b?g.error(b):g.debug("Message sent to "+a+"/"+c.message)})};
exports.template=function(b,c,g,f,h,q){a.renderView("emails/"+g,f,function(a){exports.html(b,c,a,h,q)})}})();(function(){var c={},b=require("../conf.js").conf(),a=b.logger,h=require("mongoose"),b="mongodb://"+b.MONGO_HOST+":"+b.MONGO_PORT+"/"+b.MONGO_DB_PREFIX+b.env.toLowerCase();h.connect(b);a.info("Connecting to mongo on "+b);exports.loadModel=function(a){c[a]=require("../models/"+a.toLowerCase()+".js").define(h)};exports.model=function(a){c[a]||exports.loadModel(a);return c[a]};exports.find=function(b,c,e){"string"===typeof b&&(b=exports.model(b));b.findById(c,function(b,c){b&&a.error("Error querying db",
b);"function"===typeof e&&e(b,c)})};exports.findAll=function(b,c,e,d,h,n){var l=b&&b.query?parseInt(b.query.page,10)||1:1,q=h?h.limit||20:20;"string"===typeof c&&(c=exports.model(c));c.count(e||{},function(b,g){b&&a.error("Error querying db",b);c.find(e||{},d||{},exports.page(l,h),function(b,c){b&&a.error("Error querying db",b);"function"===typeof n&&n(b,{docs:c,total:g,limit:q,page:l,hasNext:q*l<g,hasPrevious:1<l})})})};exports.page=function(b,a){var c,d;c=a?a.limit||20:20;c={skip:c*(b-1),limit:c};
if(a)for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);return c}})();(function(){exports.error=function(c){this.respond(c||404,"text/plain","File not found")};exports.html=function(c,b){this.respond(b||200,"text/html",c)};exports.plain=function(c,b){this.respond(b||200,"text/plain",c)};exports.json=function(c,b){this.respond(b||200,"application/json","string"===typeof c?c:JSON.stringify(c))};exports.respond=function(c,b,a){this.writeHead(c,{"Content-type":b});this.end(a)};exports.redirect=function(c){this.writeHead(302,{Location:c});this.end()}})();(function(){var c=require("./share/slack.js").slack;exports.share=function(b,a,h){switch(a.type){case "slack":c(b,a,h);return}"function"===typeof h&&h({error:"Social network not found"})}})();(function(){exports.email=function(c){var b,a;if(!c||"string"!==typeof c)return!1;b=c.indexOf("@");a=c.lastIndexOf(".");return 0<b&&3<a&&b<a&&c.length>a+2}})();(function(){exports.define=function(c){return c.model("Document",new c.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(c){return c.model("Filter",new c.Schema({color:String,name:String,building:{type:Boolean,"default":!0},fields:c.Schema.Types.Mixed}))}})();(function(){exports.define=function(c){return c.model("Job",new c.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{doc_title:String,doc_published_date:Number,doc_description:String,doc_source_name:String,doc_source_url:String,doc_source_feed_url:String,doc_description_quality:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){var c=require("../lib/internet.js");exports.define=function(b){var a=new b.Schema({name:String,url:String,feed_url:{type:String,index:!0},type:{type:String,"default":"CONTENT"},quality:{type:String,"default":"NORMAL"},customer_id:{type:String,index:!0},last:{type:Number},successive_errors:{type:Number,"default":0},fake:{type:Boolean,"default":!1}});b=b.model("Source",a);a.pre("save",function(a){var b=this,f=!1,e=0,d=function(b){b&&(f=!0);e+=1;2===e&&a(f?Error("Validation error"):null)};
c.get(this.url,function(a,c,e){a&&b.invalidate("url","URL is invalid");d(a)});this.feed_url?c.feed(this.feed_url,function(a,c,e){a&&b.invalidate("url","Feed URL is invalid");d(a)}):d()});return b}})();(function(){exports.define=function(c){return c.model("Subscriber",new c.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.campaigns={b:"Blog",r1:"Reddit landing feedback",r2:"Reddit marketing campaign",t1:"Twitter Minethat link",t2:"Twitter xav link",c1:"First marketing campaign",e1:"Xav email footer",e2:"Minethat email footer",e3:"Newsletters"}})();(function(){var c=require("./routes.js").routes,b={},a=require("urlrouter");exports.setup=function(a,b,c,e,d){if("function"!==typeof e[d])throw Error('Route "'+c+'" is invalid:  function "'+d+'" does not exist in controller.');a[b](c,function(a,b,g){0===c.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;e[d](a,b,g)})};exports.route=function(a,c,f){var e=f[1].split(".");b[e[0]]||(b[e[0]]=require("../controllers/"+e[0]+".js"));2>e.length&&(e[1]="index");exports.setup(a,f[0],c,b[e[0]],e[1])};exports.apply=function(a){var b,
f,e;for(b in c)if(c.hasOwnProperty(b))if("string"===typeof c[b][0])exports.route(a,b,c[b]);else for(f=0,e=c[b].length;f<e;f+=1)exports.route(a,b,c[b][f])};exports.router=function(){return a(exports.apply)}})();(function(){exports.add=function(c,b){exports.routes[c]=b};exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/doc/:id":["get","document.display"],"/app/docs":[["get","document.search"],["post","document.search"]],"/app/filter/new":[["get","filter.create"],
["post","filter.create"]],"/app/filters/estimate":["post","filter.estimate"],"/app/filter/wall/:id":["get","filter.wall"],"/app/filter/:id":[["get","filter.edit"],["post","filter.edit"]],"/admin/subscribers":["get","subscriber"],"/admin/subscribers.csv":["get","subscriber.csv"],"/admin/subscriber/:id":["get","subscriber.display"],"/app/jobs":["get","job.index"],"/api/v1/sources":["get","source.index"],"/api/v1/sources/check":["post","source.check"],"/api/v1/sources/import":["post","source.from_feed"],
"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],"/api/v1/source":["post","source.add"],"/api/v1/filters/:id":[["get","filter.edit"],["post","filter.edit"],["delete","filter.remove"]],"/api/v1/document/:id":[["get","document.display"],["delete","document.remove"]],"/api/v1/documents/recent":[["get","document.recent"]],"/api/v1/documents/export":[["get","document.export_bunch"]],"/api/v1/job/:id":["delete","job.remove"],"/api/v1/submit/url":["post",
"submit.url"],"/api/v1/submit/string":["post","submit.string"],"/api/v1/submit/html_string":["post","submit.html_string"],"/":["get","home"],"/devlog":["get","blog"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();(function(){var c=require("../internet.js");exports.share=function(b,a,h){c.postJSON()}})();
