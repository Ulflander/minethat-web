(function(b){var a,e,d,g=require("./lib/job.js"),f=require("./lib/internet.js"),c=0;require("./conf.js").conf(function(c){a=c.logger;e=require("./lib/models.js");d=e.model("Source");setInterval(b.update,"local"===c.env?3E4:1E4);b.update()});b.submit=function(c,b){console.log(b);g.makeup({customerId:"2c7f9a",gateway:"API",status:"VOID",type:"feed_url",value:b.link[0],meta:{doc_title:b.title[0],doc_published_date:b.date,doc_description:b.desc[0]}},function(c){c&&a.error("Unable to publish job",c)})};
b.aggregate=function(c,a){f.feed(c.feed_url,function(e,g){var f=g.items,d,n=0,q=f.length;for(d=0;d<q;d+=1)f[d].date>(c.last||0)&&(b.submit(c,f[d]),f[d].date>n&&(n=f[d].date));0<n&&(c.last=n);a(c)})};b.check=function(c){b.aggregate(c,function(c){d.update({_id:c._id},{last:c.last},function(c,h,b){c?a.error("Error updating source",c):0===h&&a.error("Error updating source: no item affected")})})};b.update=function(){d.find({},{},{skip:c,limit:1},function(h,e){if(h)a.error("Error querying db",h);else{var f,
g=e.length;if(0===g)c=0;else for(c+=1,f=0;f<g;f+=1)b.check(e[f])}})}})(exports);(function(b){var a=process.env.ENV,e,d=require("fs"),g=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(c){5===c.level?console.error(c.output):console.log(c.output)}}),f={loaded:!1,logger:g,env:a};"string"!==typeof a&&(g.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));e=__dirname+"/../../../conf/conf."+a+".sh";b.parseLine=
function(c){0!==c.indexOf("#")&&0<c.indexOf("=")&&(c=c.split("="),f[c[0]]=/^[0-9]+$/ig.test(c[1])?parseInt(c[1],10):c[1])};b.parse=function(c){c=c.split("\n");var h,a=c.length;for(h=0;h<a;h+=1)b.parseLine(c[h])};b.read=function(c){f.loaded=!0;d.readFile(e,function(h,a){h&&(g.error("No way to load conf",h),process.exit(1));b.parse(a.toString());d.realpath(__dirname+"/../../",function(h,b){h&&(g.error("No way to get root path",h),process.exit(1));f.root=b;"function"===typeof c&&c(f)})});return f};b.conf=
function(c){return f.loaded?f:b.read(c)}})(exports);(function(){require("./conf.js").conf(function(b){require("./server.js").run(b)})})();(function(b){var a=require("connect"),e=require("serve-static"),d=require("body-parser"),g=require("./lib/blog.js"),f=require("./lib/init.js").initialize,c=require("./routes/router.js").router,h=require("./lib/job.js"),l=require("./controllers/404.js");b.run=function(b){var k=a();k.conf=b;k.logger=b.logger;h.init();g.init(function(){k.use(require("./lib/auth.js").auth);k.use(e(b.WEB_SERVER_STATIC_PATH||__dirname+"/../../dist"));k.use(d({limit:"10mb"}));k.use(f);k.use(c());k.use(l.index);k.listen(b.WEB_SERVER_PORT);
k.logger.log("Server started on "+b.WEB_SERVER_HOST+":"+b.WEB_SERVER_PORT)})}})(exports);(function(){var b=require("../lib/controller-view.js");exports.index=function(a,e,d){a.logger.warn("Page not found: ["+a.method+"] "+a.url);b.view(a,e,"404.html")}})();(function(){var b=require("../lib/controller-view.js"),a=/<p>([^<]+)/im,e={},d={};exports.add=function(b,f){e[b]=f;var c=a.exec(f);d[b]=c?c[1].split("\n").join(" "):""};exports.index=function(a,f,c){c=[];var h,d;for(h in e)e.hasOwnProperty(h)&&(d=h.split("/blog/").join("").split(".html").join("").split("-"),c.push({url:"/blog/"+d.join("-")+".html",date:d.splice(0,3).join("/"),title:d.join(" ")}));b.view(a,f,"blog/articles.html",{articles:c})};exports.article=function(a,f,c){c=a.url.split("/blog/").join("").split(".html").join("").split("-");
b.view(a,f,"blog/article.html",{summary:d[a.url],url:"http://www.minethat.co"+a.url,content:e[a.url]||"Article not found",date:c.splice(0,3).join("/"),title:c.join(" ")})}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(a,e,d){b.findAll(a,e,"Document",null,null,null,"document/list.html")};exports.display=function(a,e,d){b.find(a,e,"Document","document/display.html")};exports.remove=function(a,e,d){b.remove(a,e,"Document")}})();(function(){var b=require("../lib/controller-view.js"),a=require("../lib/valid.js"),e=require("../lib/mail.js"),d=require("url"),g=require("ua-parser-js"),f=require("../routes/campaigns.js").campaigns;exports.campaign=function(c){var h={ref_campaign:"None",ref_domain:"Unknown"};c.query&&c.query.r&&(h.ref_campaign=f[c.query.r]||c.query.r);c.headers.referer&&(h.ref_domain=d.parse(c.headers.referer).hostname,0===h.ref_domain.indexOf("www.")&&(h.ref_domain=h.ref_domain.substr(4)));return h};exports.index=
function(c,h,a){b.view(c,h,"landing/landing.html",exports.campaign(c))};exports.subscribe=function(c,h,b){b=c.model("Subscriber");if(!c.body||!c.body.email)return h.json({error:"miss_param"},500);if(!a.email(c.body.email))return h.json({error:"invalid_email"},500);b.findOne({email:c.body.email},function(b,a){if(b)return h.json({error:"db_check_failed"},500);if(a)return h.json({status:"exists",id:a._id},200);exports.create(c,h)})};exports.create=function(c,h){var b=c.model("Subscriber"),a=(new g).setUA(c.headers["user-agent"]).getResult()||
{},f=new b({email:c.body.email,ref_campaign:c.body.ref_campaign,ref_domain:c.body.ref_domain,browser:a.browser&&a.browser.name?a.browser.name:"Unknown",os:a.os&&a.os.name?a.os.name:"Unknown",device:a.device&&a.device.vendor?a.device.vendor+" / "+(a.device.model||"Unknown"):"Unknown"});f.save(function(a){if(a)return h.json({error:"db_save_failed"},500);e.template(c.body.email,"You're in!","landing-subscribed.html",{sub:f});e.template("xav@minethat.co","He's in!","landing-subscribed-alert.html",{sub:f});
h.json({status:"success"})})}})();(function(){var b=require("../lib/controller-view.js"),a=require("../lib/internet.js");exports.index=function(a,d,g){b.findAll(a,d,"Source",null,null,null,"source/list.html")};exports.display=function(a,d,g){b.find(a,d,"Source","source/edit.html")};exports.from_feed=function(e,d,g){"GET"===e.method?b.view(e,d,"source/from_feed.html"):a.feed(e.body.feed_url,function(a,c){a||!c?b.view(e,d,"source/from_feed.html",{error:"Invalid feed"}):(e.body.name=c.metadata.title,e.body.url=c.metadata.url,exports.add(e,
d,g))})};exports.add=function(a,d,g){b.create(a,d,"Source","source/edit.html","/app/source/:id")};exports.edit=function(a,d,g){b.edit(a,d,"Source","source/edit.html")};exports.check=function(b,d,g){a.feed(b.body.feed_url,function(a,c){a||!c?d.json({status:"error",error:"Invalid feed"},422):b.findAll(b,"Source",{feed_url:b.body.feed_url},null,null,function(c,a){c?d.json({status:"error",error:"Internal error"},500):(console.log(a),0===a.total?d.json({status:"success"},200):d.json({status:"exists"},
409))})})};exports.remove=function(a,d,g){b.remove(a,d,"Source")}})();(function(){var b=require("../lib/job.js");exports.html_string=function(a,b,d){if(!a.body.content)return b.json({status:"error",error:'Missing "content" parameter'},500);exports.submit(a,b,"HTML_STRING",a.body.content)};exports.string=function(a,b,d){if(!a.body||!a.body.string)return b.json({status:"error",error:'Missing "string" parameter'},500);exports.submit(a,b,"STRING",a.body.string)};exports.url=function(a,b,d){if(!a.body||!a.body.url)return b.json({status:"error",error:'Missing "url" parameter'},
500);exports.submit(a,b,"URL",a.body.url)};exports.submit=function(a,e,d,g){console.log("[API] Got request");var f={customerId:"2c7f9a",gateway:"API",status:"VOID",type:d,value:g};a.body.meta&&(f.meta=a.body.meta);if(a.body.target&&"TRAIN"===a.body.target){if(!a.body||!a.body.classes)return e.json({status:"error",error:'Missing "classes" parameter'},500);f.target="TRAIN";f.classes=a.body.classes}b.makeup(f,function(c){return c?e.json({status:"error",error:"DB error"},500):e.json({status:"success",
job:f._id})})}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(a,e,d){b.findAll(a,e,"Subscriber",null,null,null,"subscriber/list.html")};exports.display=function(a,e,d){b.find(a,e,"Subscriber","subscriber/display.html")};exports.csv=function(a,e,d){b.find(a,e,"Subscriber","subscriber/display.html")}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(a,e){var d=a.model("Subscriber");if(!a.query.id)return e.error("Missing param for unsubscription",500);d.findById(a.query.id,function(d,f){var c=null;if(d)return e.error("DB query error",500);a.query.action&&("unsubscribe"===a.query.action?(f.unactivated=!0,c="Done! You won't receive our newsletter anymore."):(f.unactivated=!1,c="Thanks! You're now subscribed to our newsletter!"),f.save());b.view(a,e,"subscriber/subscription.html",
{msg:c,sub:f})})}})();(function(){var b=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(a,e,d){0===a._parsedUrl.href.indexOf("/private")||0===a._parsedUrl.href.indexOf("/admin")||0===a._parsedUrl.href.indexOf("/app")?b.check(a,e,function(a){d()}):d()}})();(function(){var b=require("fs"),a=require("../routes/routes.js"),e=require("../controllers/blog.js"),d=require("marked"),g=require("../conf.js").conf();exports.add=function(f){var c=f.split(".md").join("");a.add("/blog/"+c+".html",["get","blog.article"]);b.readFile(g.root+"/src/blog/"+f,function(a,b){a?g.logger.error("Unable to read blog article"+g.root+"/src/blog/"+f,a):d(b.toString(),{},function(a,b){a?g.logger.error("Unable to convert blog article"+g.root+"/src/blog/"+f,a):e.add("/blog/"+c+".html",
b)})})};exports.init=function(a){b.readdir(g.root+"/src/blog/",function(c,b){if(c)g.logger.error('Blog files not found at "'+g.root+'/src/blog/"',c);else{var d,e=b.length;for(d=0;d<e;d+=1)-1<b[d].indexOf(".md")&&exports.add(b[d]);"function"===typeof a&&a()}})}})();(function(){var b=require("ejs"),a=require("fs"),e=require("async"),d=require("../conf.js").conf(),g=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,f={};exports.remove=function(c,a,b,d){c.isAPI?c.model(b).findById(c.params.id,function(c,b){c||null===b?a.json({status:"error",error:"Resource not found"},404):b.remove(function(c){c?a.json({status:"error",error:"Resource not deleted"},500):a.json({status:"success"},200)})}):a.error(404,"Only available through API")};exports.save=function(c,a,b,
d,f){var g=new (c.model(b))(c.body),e=!1;g.save(function(b){var l={status:b?"success":"error",doc:g.toObject()};e||(e=!0,b&&(l.error={message:b}),c.isAPI?a.json(l,b?500:200):f?a.redirect(f.split(":id").join(g._id)):exports.view(c,a,d,l))})};exports.create=function(c,a,b,d,f){var g=c.model(b);"POST"===c.method?exports.save(c,a,b,d,f):c.isAPI?a.json({error:"Not implemented"},500):exports.view(c,a,d,{doc:new g,status:"create"})};exports.find=function(c,a,b,d){c.find(b,c.params.id,function(b,f){if(b)return a.error(500);
f?(console.log(f.toObject()),c.isAPI?a.json(f.toObject()):exports.view(c,a,d,{doc:f,status:"exists"})):c.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})};exports.edit=function(c,a,b,f){"GET"===c.method?exports.find(c,a,b,f):c.model(b).update({_id:c.params.id},c.body,function(d,g,e){if(d)return a.error(500);c.find(b,c.params.id,function(b,d){if(b)return a.error(500);d?c.isAPI?a.json(d):exports.view(c,a,f,{doc:d,status:"exists"}):c.isAPI?a.json({status:"error",error:"Resource not found"},
404):a.error(404)})})};exports.findAll=function(c,a,b,d,f,g,e){c.findAll(c,b,d,f,g,function(b,d){if(b)return a.error(404);c.isAPI?a.json(d):exports.view(c,a,e,d)})};exports.requiresLoading=function(c){return!f[c]||"local"===d.env};exports.load=function(c,b){a.readFile(__dirname+"/../views/"+c,function(a,g){a?(d.logger.error("File not found: views/"+c),f[c]="Template not found"):f[c]=g.toString();var e=exports.detectPartials(c);0<e.length?exports.loadPartials(e,b):"function"===typeof b&&b()})};exports.render=
function(c,a){try{return b.render(f[c],{data:a?a:{},partial:exports.partial,env:d.env})}catch(g){return d.logger.error("Unable to render template",g),null}};exports.view=function(c,a,b,d){exports.renderView(b,d,function(c){a.html(c)})};exports.renderView=function(c,a,b){var d=function(){b(exports.render(c,a))};if(exports.requiresLoading(c))return exports.load(c,d);d()};exports.partial=function(a,g){var e={data:g};e.env=d.env;e.partial=exports.partial;return b.render(f["_partials/"+a+".html"],e)};
exports.loadPartials=function(a,b){var d,f=a.length,g=[];for(d=0;d<f;d+=1)g.push(exports.loadPartial(a[d]));e.parallel(g,b)};exports.loadPartial=function(a){return function(b){exports.load("_partials/"+a+".html",b)}};exports.detectPartials=function(a){for(var b=[],d;;){d=g.exec(f[a]);if(!d)break;b.push(d[1])}return b}})();(function(){var b=require("../conf.js").conf(),a=require("./respond.js"),e=require("./models.js"),d=require("qs");exports.initialize=function(g,f,c){var h;g.logger=b.logger;g.query=d.parse(g._parsedUrl.query);for(h in e)e.hasOwnProperty(h)&&(g[h]?b.logger.error("Injection failed: key "+h+"already defined in Request object"):g[h]=e[h]);for(h in a)a.hasOwnProperty(h)&&(f[h]?b.logger.error("Injection failed: key "+h+"already defined in Response object"):f[h]=a[h]);c()}})();(function(){var b=require("request"),a=require("blindparser");exports.get=function(a,d){b(a,function(a,b){a||200!==b.statusCode?d(a):d(null,b.body,b.href)})};exports.feed=function(b,d){exports.get(b,function(b,f,c){if(b)d(b);else try{a.parseString(f,{},function(a,b){a?d(a):d(null,b)})}catch(e){d(e)}})}})();(function(){var b=require("amqp"),a=require("../conf.js").conf(),e=!1,d=require("./models.js"),g;exports.init=function(d){g=b.createConnection({host:a.RABBIT_HOST,port:a.RABBIT_PORT});g.on("ready",function(){console.log("[RabbitMQ] Connection established");g.queue(a.RABBIT_EXTRACT_QUEUE,{durable:!0,exclusive:!1,autoDelete:!1},function(a){console.log("[RabbitMQ] Queue declared");e=!0;"function"===typeof d&&d()})});g.on("error",function(){e=!1;console.log("[RabbitMQ] Error",arguments)})};exports.makeup=
function(a,b){var g=new (d.model("Job"))(a);g.save(function(a){a||exports.publish(g._id);"function"===typeof b&&b(a,g)})};exports.publish=function(a){e?(console.log("[RabbitMQ] Submitted job "+a),g.publish("extract",a)):setTimeout(function(){exports.publish(a)},100)}})();(function(){var b,a=require("html-to-text"),e=require("./controller-view.js"),d=require("../conf.js").conf(),g=d.logger,f=require("nodemailer");exports.html=function(c,e,l,m,k){b||(b=f.createTransport("SMTP",{service:"Gmail",auth:{user:d.WEB_EMAIL_USER,pass:d.WEB_EMAIL_PASS}}));b.sendMail({from:m||"Xav from Minethat <xav@minethat.co>",to:c,subject:e,text:k||a.fromString(l),html:l},function(a,b){a?g.error(a):g.debug("Message sent: "+b.message)})};exports.template=function(a,b,d,f,g,p){e.renderView("emails/"+
d,f,function(d){exports.html(a,b,d,g,p)})}})();(function(){var b={},a=require("../conf.js").conf(),e=a.logger,d=require("mongoose");d.connect("mongodb://"+a.MONGO_HOST+":"+a.MONGO_PORT+"/"+a.MONGO_DB_PREFIX+a.env.toLowerCase());exports.loadModel=function(a){b[a]=require("../models/"+a.toLowerCase()+".js").define(d)};exports.model=function(a){b[a]||exports.loadModel(a);return b[a]};exports.find=function(a,b,c){"string"===typeof a&&(a=exports.model(a));a.findById(b,function(a,b){a&&e.error("Error querying db",a);"function"===typeof c&&c(a,b)})};
exports.findAll=function(a,b,c,d,l,m){var k=a.query?parseInt(a.query.page,10)||1:1;"string"===typeof b&&(b=exports.model(b));b.count(c||{},function(a,g){a&&e.error("Error querying db",a);b.find(c||{},d||{},exports.page(k,l),function(a,b){a&&e.error("Error querying db",a);"function"===typeof m&&m(a,{docs:b,total:g,limit:20,page:k,hasNext:20*k<g,hasPrevious:1<k})})})};exports.page=function(a,b){var c,d;c={skip:20*(a-1),limit:20};if(b)for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c}})();(function(){exports.error=function(b){this.respond(b||404,"text/plain","File not found")};exports.html=function(b,a){this.respond(a||200,"text/html",b)};exports.plain=function(b,a){this.respond(a||200,"text/plain",b)};exports.json=function(b,a){this.respond(a||200,"application/json","string"===typeof b?b:JSON.stringify(b))};exports.respond=function(b,a,e){this.writeHead(b,{"Content-type":a});this.end(e)};exports.redirect=function(b){this.writeHead(302,{Location:b});this.end()}})();(function(){exports.email=function(b){var a,e;if(!b||"string"!==typeof b)return!1;a=b.indexOf("@");e=b.lastIndexOf(".");return 0<a&&3<e&&a<e&&b.length>e+2}})();(function(){exports.define=function(b){return b.model("Document",new b.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(b){return b.model("Job",new b.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{url:String,title:String,author:String,organization:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){var b=require("../lib/internet.js");exports.define=function(a){var e=new a.Schema({name:String,url:String,feed_url:{type:String,index:!0},type:{type:String,"default":"CONTENT"},customer_id:{type:String,index:!0},last:{type:Number},fake:{type:Boolean,"default":!1}});a=a.model("Source",e);e.pre("save",function(a){var e=this,f=!1,c=0,h=function(b){b&&(f=!0);c+=1;2===c&&a(f?Error("Validation error"):null)};b.get(this.url,function(a,b,c){a&&e.invalidate("url","URL is invalid");h(a)});b.feed(this.feed_url,
function(a,b,c){a&&e.invalidate("url","Feed URL is invalid");h(a)})});return a}})();(function(){exports.define=function(b){return b.model("Subscriber",new b.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.campaigns={b:"Blog",r1:"Reddit landing feedback",r2:"Reddit marketing campaign",t1:"Twitter Minethat link",t2:"Twitter xav link",c1:"First marketing campaign",e1:"Xav email footer",e2:"Minethat email footer",e3:"Newsletters"}})();(function(){var b=require("./routes.js").routes,a={},e=require("urlrouter");exports.setup=function(a,b,e,c,h){if("function"!==typeof c[h])throw Error('Route "'+e+'" is invalid:  function "'+h+'" does not exist in controller.');a[b](e,function(a,b,d){0===e.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;c[h](a,b,d)})};exports.route=function(b,e,f){var c=f[1].split(".");a[c[0]]||(a[c[0]]=require("../controllers/"+c[0]+".js"));2>c.length&&(c[1]="index");exports.setup(b,f[0],e,a[c[0]],c[1])};exports.apply=function(a){var e,
f,c;for(e in b)if(b.hasOwnProperty(e))if("string"===typeof b[e][0])exports.route(a,e,b[e]);else for(f=0,c=b[e].length;f<c;f+=1)exports.route(a,e,b[e][f])};exports.router=function(){return e(exports.apply)}})();(function(){exports.add=function(b,a){exports.routes[b]=a};exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/document/:id":["get","document.display"],"/admin/subscribers":["get","subscriber"],"/admin/subscribers.csv":["get","subscriber.csv"],
"/admin/subscriber/:id":["get","subscriber.display"],"/api/v1/sources":["get","source.index"],"/api/v1/sources/check":["post","source.check"],"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],"/api/v1/source":["post","source.add"],"/api/v1/document/:id":[["get","document.display"],["delete","document.remove"]],"/api/v1/submit/url":["post","submit.url"],"/api/v1/submit/string":["post","submit.string"],"/api/v1/submit/html_string":["post","submit.html_string"],
"/":["get","home"],"/blog":["get","blog"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();
