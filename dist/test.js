var util=require("util"),Twitter=require("twitter"),moment=require("moment"),Entities=require("html-entities").AllHtmlEntities,entities=new Entities,twit=new Twitter({consumer_key:"WO30xPwtmdSOzOmoJ5ruAdeHH",consumer_secret:"IH6UltER7AQsA9Y3vUCDGJxi3AKS4NbzcXDICwBGergu3wJKvm",access_token_key:"58438762-2U1PaQyuvH9DIxcNU40rKxzjmz1klqYSzOlTY8tVk",access_token_secret:"ZGZF2dsQLshYautCNjuxbO7lM6gzRYJVEISDBrc07Kxep"});
(function(a){var b,c,e,g,h=require("./lib/internet.js"),f=0;require("./conf.js").conf(function(d){b=d.logger;c=require("./lib/models.js");g=require("./lib/job.js");e=c.model("Source");setInterval(a.update,"local"===d.env?1E4:1E3);b.log("Aggregator started...");g.init(a.update)});a.markError=function(d,a){d.successive_errors||(d.successive_errors=0);d.successive_errors+=1;e.update({_id:d._id},{successive_errors:d.successive_errors,last_error:a?a.toString():""},function(d,a,c){d?b.error("Error updating source",
d):0===a&&b.error("Error updating source: no item affected")})};a.getLinkField=function(d){if("string"===typeof d.origlink)return d.origlink;if(Array.isArray(d.origlink))return d.origlink[0];if("string"===typeof d.link)return d.link;if(Array.isArray(d.link))return d.link[0]};a.getTitleField=function(d){var a="";"string"===typeof d.title&&(a=d.title);Array.isArray(d.title)&&(a=d.title[0]);return entities.decode(a.replace(/(<([^>]+)>)/ig," "))};a.getDescField=function(d){var a="";"string"===typeof d.description&&
(a=d.description);Array.isArray(d.description)&&(a=d.description[0]);"string"===typeof d.desc&&(a=d.desc);Array.isArray(d.desc)&&(a=d.desc[0]);return entities.decode(a.replace(/(<([^>]+)>)/ig," "))};a.submit=function(d,c){var f=a.getLinkField(c);f?(b.debug("Publishing "+f+" via "+d.name),f={customerId:"2c7f9a",gateway:"API",status:"VOID",type:"FEED_URL",value:f,meta:{doc_description_quality:d.quality,doc_title:a.getTitleField(c),doc_published_date:c.date,doc_description:a.getDescField(c),doc_source_name:d.name,
doc_source_url:d.url,doc_source_id:d._id,doc_source_feed_url:d.feed_url}},g.makeup(f,function(c){c&&(b.warn("Unable to publish job for "+d.name,c),a.markError(d,c))})):b.debug("Unable to publish: no link, via "+d.name)};a.aggregate=function(d,c){h.feed(d.feed_url,function(f,h){if(f)b.warn("Unable to retrieve feed items: "+d.name,f),a.markError(d,f);else{var e=h.items,g,p=0,r=!1,n,t=e.length;for(g=0;g<t;g+=1)n=e[g].date,isNaN(n)&&(n=moment(n).valueOf()),"object"===typeof n&&"function"===typeof n.getTime&&
(n=n.getTime()),"number"!==typeof n||0===n?(b.warn("Feed article date is not valid"),a.markError(d)):n>(d.last||0)&&(e[g].date=n,a.submit(d,e[g]),r=!0,n>p&&(p=n));0===p&&!1!==r?(b.warn("Unable to retrieve feed items: "+d.name),a.markError(d)):(0<p&&(d.last=p),c(d))}})};a.check=function(d){a.aggregate(d,function(d){e.update({_id:d._id},{last:d.last,successive_errors:0},function(d,a,c){d?b.error("Error updating source",d):0===a&&b.error("Error updating source: no item affected")})})};a.update=function(){e.find({$or:[{successive_errors:{$lt:4}},
{successive_errors:{$exists:!1}}]},{},{skip:f,limit:2},function(d,c){if(d)b.error("Error querying db",d);else{var g,e=c.length;if(0===e)b.log("No source found"),f=0;else for(f+=1,g=0;g<e;g+=1)a.check(c[g])}})}})(exports);(function(a){return!0})(exports);(function(a){var b=process.env.ENV,c,e=require("fs"),g=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(d){5===d.level?console.error(d.output):console.log(d.output)}}),h=!1,f={loaded:!1,logger:g,env:b};"string"!==typeof b&&(g.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));c=__dirname+"/../../../conf/conf."+b+".sh";
a.parseLine=function(d){0!==d.indexOf("#")&&0<d.indexOf("=")&&(d=d.split("="),f[d[0].trim()]=/^[0-9]+$/ig.test(d[1])?parseInt(d[1],10):d[1].trim())};a.parse=function(d){d=d.split("\n");var c,b=d.length;for(c=0;c<b;c+=1)a.parseLine(d[c])};a.read=function(d){h=!0;e.realpath(c,function(b,m){b&&(g.error("No way to solve path "+c,b),process.exit(1));g.log("Loading configuration at "+m);e.readFile(m,function(c,b){c&&(g.error("No way to load conf",c),process.exit(1));a.parse(b.toString());e.realpath(__dirname+
"/../../",function(c,a){c&&(g.error("No way to get root path",c),process.exit(1));f.root=a;h=!1;f.loaded=!0;g.log("Configuration loaded ...");"function"===typeof d&&d(f)})})});return f};a.wait=function(d){setTimeout(function(){f.loaded?d(f):a.wait(d)},15)};a.conf=function(d){if(f.loaded)return"function"===typeof d&&d(f),f;if(!h)return a.read(d);"function"===typeof d&&a.wait(d);return f}})(exports);(function(){require("./conf.js").conf(function(a){require("./server.js").run(a)})})();(function(a){var b=require("connect"),c=require("serve-static"),e=require("body-parser"),g=require("./lib/blog.js"),h=require("./lib/init.js").initialize,f=require("./routes/router.js").router,d=require("./lib/job.js"),k=require("./controllers/404.js");a.run=function(a){var l=b();l.conf=a;l.logger=a.logger;d.init();g.init(function(){l.use(require("./lib/auth.js").auth);l.use(c(a.WEB_SERVER_STATIC_PATH||__dirname+"/../../dist"));l.use(e({limit:"10mb"}));l.use(h);l.use(f());l.use(k.index);l.listen(a.WEB_SERVER_PORT);
l.logger.log("Server started on "+a.WEB_SERVER_HOST+":"+a.WEB_SERVER_PORT)})}})(exports);(function(a){var b=require("../lib/controller-view.js");a.index=function(c,a,g){c.logger.warn("Page not found: ["+c.method+"] "+c.url);b.view(c,a,"404.html",{value:1E3,url:null},404)}})(exports);(function(){var a=require("../lib/controller-view.js"),b=/<p>([^<]+)/im,c={},e={};exports.add=function(a,h){c[a]=h;var f=b.exec(h);e[a]=f?f[1].split("\n").join(" "):""};exports.index=function(b,e,f){f=[];var d,k;for(d in c)c.hasOwnProperty(d)&&(k=d.split("/devlog/").join("").split(".html").join("").split("-"),f.unshift({url:"/devlog/"+k.join("-")+".html",date:k.splice(0,3).join("/"),title:k.join(" ")}));a.view(b,e,"blog/articles.html",{articles:f})};exports.article=function(b,h,f){f=b.url.split("/devlog/").join("").split(".html").join("").split("-");
a.view(b,h,"blog/article.html",{summary:e[b.url],url:"http://www.minethat.co"+b.url,content:c[b.url]||"Article not found",date:f.splice(0,3).join("/"),title:f.join(" ")})}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,c,e){a.findAll(b,c,"Customer",null,null,null,"customer/list.html")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,c,e){a.findAll(b,c,"Document",null,null,{sort:{"properties.meta.doc_published_date":-1},limit:50},"document/list.html")};exports.recent=function(b,c,e){if(!b.isAPI)return e();a.findAll(b,c,"Document",{status:"MINED"},"properties.meta",{sort:{"properties.meta.doc_published_date":-1},limit:10})};exports.display=function(b,c,e){a.find(b,c,"Document","document/display.html")};exports.export_bunch=function(b,c,e){a.findAll(b,
c,"Document",{status:"MINED"},null,{sort:{"properties.meta.doc_published_date":-1},limit:100})};exports.remove=function(b,c,e){a.remove(b,c,"Document")};exports.search=function(b,c,e){e={status:"MINED"};c._data={search:null};"POST"===b.method&&(e["properties.keywords.main"]=b.body.keywords);a.findAll(b,c,"Document",e,null,{sort:{"properties.meta.doc_published_date":-1}},"document/search.html")}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/filter-utils");exports.create=function(c,e,g){"GET"===c.method?a.view(c,e,"filter/edit.html"):(c.body=b.toFilterModel(c.body),console.log(c.body),a.create(c,e,"Filter","filter/edit.html","/app/filters/:id"))};exports.edit=function(c,e,g){"POST"===c.method&&(c.body=b.toFilterModel(c.body));a.edit(c,e,"Filter","filter/edit.html")};exports.estimate=function(c,e,g){var h=b.toCondition(c.body);exports.countWeeks(c,h,[],function(b,
d){var k,g=d.length,l=0;if(b)c.logger.warn("Unable to get counts per week",b);else{for(k=0;k<g;k+=1)l+=d[k].value;e.global.avg_per_week=(l/g).toFixed(0);e.global.count_per_week=d}delete h["properties.meta.doc_published_date"];a.findAll(c,e,"Document",h,null,{sort:{"properties.meta.doc_published_date":-1}},"filter/estimation.html")})};exports.wall=function(c,e,g){c.find("Filter",c.params.id,function(h,f){if(h||!f)return h&&console.error("Unable to find filter",h),g();a.findAll(c,e,"Document",b.toCondition(f.fields),
null,{sort:{"properties.meta.doc_published_date":-1}},"filter/wall.html")})};exports.remove=function(c,b,g){a.remove(c,b,"Filter")};exports.countWeeks=function(a,b,g,h){var f=g.length,d=Date.now()-6048E5*f,k=Date.now()-6048E5*(f+1);4===f?h(null,g.reverse()):(b["properties.meta.doc_published_date"]={$gt:k,$lte:d},a.model("Document").count(b,function(d,k){if(d)return h(d);g[f]={week:0===f?"Last week":"Week - "+f,value:k};exports.countWeeks(a,b,g,h)}))}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/valid.js"),c=require("../lib/mail.js"),e=require("url"),g=require("ua-parser-js"),h=require("../routes/campaigns.js").campaigns;exports.campaign=function(a){var d={ref_campaign:"None",ref_domain:"Unknown"};a.query&&a.query.r&&(d.ref_campaign=h[a.query.r]||a.query.r);a.headers.referer&&(d.ref_domain=e.parse(a.headers.referer).hostname,0===d.ref_domain.indexOf("www.")&&(d.ref_domain=d.ref_domain.substr(4)));return d};exports.index=
function(c,d,b){a.view(c,d,"landing/landing.html",exports.campaign(c))};exports.subscribe=function(a,d,c){c=a.model("Subscriber");if(!a.body||!a.body.email)return d.json({error:"miss_param"},500);if(!b.email(a.body.email))return d.json({error:"invalid_email"},500);c.findOne({email:a.body.email},function(c,b){if(c)return d.json({error:"db_check_failed"},500);if(b)return d.json({status:"exists",id:b._id},200);exports.create(a,d)})};exports.create=function(a,d){var b=a.model("Subscriber"),e=(new g).setUA(a.headers["user-agent"]).getResult()||
{},h=new b({email:a.body.email,ref_campaign:a.body.ref_campaign,ref_domain:a.body.ref_domain,browser:e.browser&&e.browser.name?e.browser.name:"Unknown",os:e.os&&e.os.name?e.os.name:"Unknown",device:e.device&&e.device.vendor?e.device.vendor+" / "+(e.device.model||"Unknown"):"Unknown"});h.save(function(b){if(b)return d.json({error:"db_save_failed"},500);c.template(a.body.email,"You're in!","landing-subscribed.html",{sub:h});c.template("xav@minethat.co","He's in!","landing-subscribed-alert.html",{sub:h});
d.json({status:"success"})})}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,c,e){a.findAll(b,c,"Job",null,null,null,"job/list.html")};exports.remove=function(b,c,e){a.remove(b,c,"Job")}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/internet.js");exports.index=function(c,b,g){a.findAll(c,b,"Source",null,null,null,"source/list.html")};exports.display=function(c,b,g){a.find(c,b,"Source","source/edit.html")};exports.from_feed=function(c,e,g){"GET"===c.method?!1===c.isAPI?a.view(c,e,"source/from_feed.html"):e.json({status:"error",error:"Unauthorized method"},401):b.feed(c.body.feed_url,function(b,f,d){if(!b&&f&&d){var k;console.log(f.metadata);"string"===typeof f.metadata.url?
k=f.metadata.url:Array.isArray(f.metadata.url)?(b=f.metadata.url[0],"string"===typeof b?k=b:b.href&&(k=b.href)):c.logger.warn("Unable to detect site url for feed",f.metadata);c.body.name=f.metadata.title;c.body.url=k;exports.add(c,e,g)}else!1===c.isAPI?a.view(c,e,"source/from_feed.html",{error:"Invalid feed"}):e.json({status:"error",error:"Invalid feed"},422)})};exports.add=function(b,e,g){a.create(b,e,"Source","source/edit.html","/app/source/:id")};exports.edit=function(b,e,g){a.edit(b,e,"Source",
"source/edit.html")};exports.check=function(a,e,g){b.feed(a.body.feed_url,function(b,f){b||!f?e.json({status:"error",error:"Invalid feed"},422):a.findAll(a,"Source",{feed_url:a.body.feed_url},null,null,function(d,a){d?e.json({status:"error",error:"Internal error"},500):0===a.total?e.json({status:"success"},200):e.json({status:"exists"},409)})})};exports.remove=function(b,e,g){a.remove(b,e,"Source")}})();(function(){var a=require("../lib/job.js");exports.html_string=function(a,c,e){if(!a.body.content)return c.json({status:"error",error:'Missing "content" parameter'},500);exports.submit(a,c,"HTML_STRING",a.body.content)};exports.string=function(a,c,e){if(!a.body||!a.body.string)return c.json({status:"error",error:'Missing "string" parameter'},500);exports.submit(a,c,"STRING",a.body.string)};exports.url=function(a,c,e){if(!a.body||!a.body.url)return c.json({status:"error",error:'Missing "url" parameter'},
500);exports.submit(a,c,"URL",a.body.url)};exports.submit=function(b,c,e,g){console.log("[API] Got request");var h={customerId:"2c7f9a",gateway:"API",status:"VOID",type:e,value:g};b.body.meta&&(h.meta=b.body.meta);if(b.body.target&&"TRAIN"===b.body.target){if(!b.body||!b.body.classes)return c.json({status:"error",error:'Missing "classes" parameter'},500);h.target="TRAIN";h.classes=b.body.classes}a.makeup(h,function(a){return a?c.json({status:"error",error:"DB error"},500):c.json({status:"success",
job:h._id})})}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,c,e){a.findAll(b,c,"Subscriber",null,null,null,"subscriber/list.html")};exports.display=function(b,c,e){a.find(b,c,"Subscriber","subscriber/display.html")};exports.csv=function(b,c,e){a.find(b,c,"Subscriber","subscriber/display.html")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,c){var e=b.model("Subscriber");if(!b.query.id)return c.error("Missing param for unsubscription",500);e.findById(b.query.id,function(e,h){var f=null;if(e)return c.error("DB query error",500);b.query.action&&("unsubscribe"===b.query.action?(h.unactivated=!0,f="Done! You won't receive our newsletter anymore."):(h.unactivated=!1,f="Thanks! You're now subscribed to our newsletter!"),h.save());a.view(b,c,"subscriber/subscription.html",
{msg:f,sub:h})})}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,c,e){a.findAll(b,c,"Target",null,null,null,"target/list.html")}})();(function(){var a=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(b,c,e){0===b._parsedUrl.href.indexOf("/private")||0===b._parsedUrl.href.indexOf("/admin")||0===b._parsedUrl.href.indexOf("/app")?a.check(b,c,function(a){e()}):e()}})();(function(){var a=require("fs"),b=require("../routes/routes.js"),c=require("../controllers/blog.js"),e=require("marked"),g=require("../conf.js").conf();exports.add=function(h){if("."!==h.substring(0,1)||"local"===g.env){var f=h.split(".md").join("");b.add("/devlog/"+f+".html",["get","blog.article"]);a.readFile(g.root+"/src/blog/"+h,function(a,b){a?g.logger.error("Unable to read blog article"+g.root+"/src/blog/"+h,a):e(b.toString(),{},function(a,d){a?g.logger.error("Unable to convert blog article"+
g.root+"/src/blog/"+h,a):c.add("/devlog/"+f+".html",d)})})}};exports.init=function(b){a.readdir(g.root+"/src/blog/",function(a,d){if(a)g.logger.error('Blog files not found at "'+g.root+'/src/blog/"',a);else{var c,e=d.length;for(c=0;c<e;c+=1)-1<d[c].indexOf(".md")&&exports.add(d[c]);"function"===typeof b&&b()}})}})();(function(){var a=require("ejs"),b=require("fs"),c=require("async"),e=require("../conf.js").conf(),g=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,h={},f={leadingZero:function(a){return 10>a?"0"+a:a},tsToReadable:function(a){a=new Date(a);return a.getMonth()+1+"/"+a.getDate()+"/"+a.getUTCFullYear()+", "+f.leadingZero(a.getHours())+":"+f.leadingZero(a.getMinutes())},moment:require("moment")};exports.remove=function(a,b,c,e){a.isAPI?a.model(c).findById(a.params.id,function(a,d){a||null===d?b.json({status:"error",
error:"Resource not found"},404):d.remove(function(a){a?b.json({status:"error",error:"Resource not deleted"},500):b.json({status:"success"},200)})}):b.error(404,"Only available through API")};exports.save=function(a,b,c,e,f){var g=new (a.model(c))(a.body),h=!1;g.save(function(c){var m={status:c?"error":"success",doc:g.toObject()};h||(h=!0,c&&(m.error={message:c}),a.isAPI?b.json(m,c?500:200):f?b.redirect(f.split(":id").join(g._id)):exports.view(a,b,e,m))})};exports.create=function(a,b,c,e,f){var g=
a.model(c);"POST"===a.method?exports.save(a,b,c,e,f):a.isAPI?b.json({error:"Not implemented"},500):exports.view(a,b,e,{doc:new g,status:"create"})};exports.find=function(a,b,c,e){a.find(c,a.params.id,function(c,f){if(c)return a.logger.warn("Error caught while querying db",c),b.error(500);f?a.isAPI?b.json(f.toObject()):exports.view(a,b,e,{doc:f,status:"exists"}):a.isAPI?b.json({status:"error",error:"Resource not found"},404):b.error(404)})};exports.edit=function(a,b,c,e){"GET"===a.method?exports.find(a,
b,c,e):a.model(c).update({_id:a.params.id},a.body,function(f,g,h){if(f)return a.logger.warn("Error caught while querying db",f),b.error(500);a.find(c,a.params.id,function(c,f){if(c)return b.error(500);f?a.isAPI?b.json(f):exports.view(a,b,e,{doc:f,status:"exists"}):a.isAPI?b.json({status:"error",error:"Resource not found"},404):b.error(404)})})};exports.findAll=function(a,b,c,e,f,g,h){a.findAll(a,c,e,f,g,function(c,e){if(c)return b.error(404);a.isAPI?b.json(e):exports.view(a,b,h,e)})};exports.requiresLoading=
function(a){return!h[a]||"local"===e.env};exports.load=function(a,c){b.readFile(__dirname+"/../views/"+a,function(b,f){b?(e.logger.error("File not found: views/"+a),h[a]="Template not found"):h[a]=f.toString();var g=exports.detectPartials(a);0<g.length?exports.loadPartials(g,c):"function"===typeof c&&c()})};exports.render=function(b,c){try{return a.render(h[b],{data:c?c:{},partial:exports.partial,env:e.env,utils:f})}catch(g){return e.logger.error("Unable to render template",g),null}};exports.view=
function(a,b,c,e,f){var g;e||(e={});if(b.global)for(g in b.global)b.global.hasOwnProperty(g)&&(e[g]=b.global[g]);exports.renderView(c,e,function(a){b.html(a,f)})};exports.renderView=function(a,b,c){var e=function(){c(exports.render(a,b))};if(exports.requiresLoading(a))return exports.load(a,e);e()};exports.partial=function(b,c){var g={data:c};g.env=e.env;g.partial=exports.partial;g.utils=f;return a.render(h["_partials/"+b+".html"],g)};exports.loadPartials=function(a,b){var e,f=a.length,g=[];for(e=
0;e<f;e+=1)g.push(exports.loadPartial(a[e]));c.parallel(g,b)};exports.loadPartial=function(a){return function(b){exports.load("_partials/"+a+".html",b)}};exports.detectPartials=function(a){for(var b=[],c;;){c=g.exec(h[a]);if(!c)break;b.push(c[1])}return b}})();(function(){exports.toFilterModel=function(a){var b={fields:{}},c;for(c in a)if(a.hasOwnProperty(c))switch(c){case "name":case "color":b[c]=a[c];break;default:b.fields[c.replace(/\./ig,"/")]=a[c]}return b};exports.toCondition=function(a){var b={status:"MINED"},c;for(c in a)a.hasOwnProperty(c)&&exports.toFieldCondition(b,c,a[c]);return b};exports.toFieldCondition=function(a,b,c){switch(b){case "keywords":if(""===c)break;a["properties.keywords.main"]={$in:c.split(",")};break;case "entities":break;default:exports.toFieldMetric(a,
b,c)}};exports.toFieldMetric=function(a,b,c){var e;b=b.replace(/\//ig,".");-1!==b.indexOf(".")&&(b=b.split("."),e=b.splice(b.length-1,1)[0],"min"===e||"max"===e)&&(c=parseFloat(c),isNaN(c)||(b=b.join("."),a[b]||(a[b]={}),"min"===e?a[b].$gte=c:a[b].$lte=c))}})();(function(a){var b=require("../conf.js").conf(),c=require("./respond.js"),e=require("./models.js"),g=require("qs");a.initialize=function(a,f,d){var k;f.global={};a.logger=b.logger;a.query=g.parse(a._parsedUrl.query);for(k in e)e.hasOwnProperty(k)&&(a[k]?b.logger.error("Injection failed: key "+k+"already defined in Request object"):a[k]=e[k]);for(k in c)c.hasOwnProperty(k)&&(f[k]?b.logger.error("Injection failed: key "+k+"already defined in Response object"):f[k]=c[k]);0===a._parsedUrl.href.indexOf("/app")?
a.findAll(null,"Filter",null,null,null,function(a,b){f.global.customer_filters=b.docs;d()}):d()}})(exports);(function(a){var b=require("request"),c=require("../conf.js").conf().logger,e=require("ortoo-feedparser"),g=require("blindparser");a.get=function(a,e,d){try{b({url:a,followAllRedirects:!0,headers:d||{"Accept-Language":"*","User-Agent":"Minethat 1.0"}},function(b,d){!b&&200<=d.statusCode&&300>d.statusCode?e(null,d.body):(c.warn("URL is invalid: "+b,d?d.statusCode:d,a),e(b))})}catch(g){c.warn("URL is invalid",a,g),e(g)}};a.feed=function(b,f,d){var k={Accept:"text/xml,application/xml,application/rss+xml",
"Accept-Language":"*","User-Agent":"Minethat 1.0"};d&&(k["If-Modified-Since"]=d);a.get(b,function(a,d){if(a)f(a);else try{g.parseString(d,{},function(a,d){a?(c.warn("URL "+b+" feed is invalid: "+a),f(a)):f(null,d,b)})}catch(k){c.log("Fallback to feedparser...");try{e.parseString(d,{},function(a,c,d){a&&f(a);f(null,{meta:c,items:d},b)})}catch(s){f("Url "+b+" feed parsing failed",s)}}},k)}})(exports);(function(){var a=require("amqp"),b=require("../conf.js").conf(),c=!1,e=require("./models.js"),g;exports.init=function(e){g=a.createConnection({host:b.RABBIT_HOST,port:b.RABBIT_PORT});g.on("ready",function(){b.logger.log("[RabbitMQ] Connection established");g.queue(b.RABBIT_EXTRACT_QUEUE,{durable:!0,exclusive:!1,autoDelete:!1},function(a){console.log("[RabbitMQ] Queue declared");c=!0;"function"===typeof e&&(e(),e=null)})});g.on("error",function(){c=!1;console.log("[RabbitMQ] Error",arguments)})};
exports.makeup=function(a,b){var c=new (e.model("Job"))(a);c.save(function(a){a||exports.publish(c._id);"function"===typeof b&&b(a,c)})};exports.publish=function(a){c?g.publish("extract",a,{deliveryMode:2}):setTimeout(function(){exports.publish(a)},100)}})();(function(){module.exports=function(a,b){if(a===b)return 0;var c=a.length,e=b.length,g=0,h=0,f,d,k,m,l=[];if(c&&e){for(;g<c;)g+=1,l[g]=g;for(;h<e;)for(m=b.charCodeAt(h),f=h,d=h+=1,g=0;g<c;g+=1)k=f+(a.charCodeAt(g)===m?0:1),f=l[g],d=d<f?d<k?d+1:k:f<k?f+1:k,l[g]=d;return d}return c+e}})();(function(){var a,b=require("html-to-text"),c=require("./controller-view.js"),e=require("../conf.js").conf(),g=e.logger,h=require("nodemailer");exports.html=function(c,d,k,m,l){a||(a=h.createTransport("SMTP",{service:"Gmail",auth:{user:e.WEB_EMAIL_USER,pass:e.WEB_EMAIL_PASS}}));g.debug("Sending message to: "+c+" (Subject: "+d+")");a.sendMail({from:m||"Xav from Minethat <xav@minethat.co>",to:c,subject:d,text:l||b.fromString(k),html:k},function(a,b){a?g.error(a):g.debug("Message sent to "+c+"/"+b.message)})};
exports.template=function(a,b,e,g,h,q){c.renderView("emails/"+e,g,function(c){exports.html(a,b,c,h,q)})}})();(function(){var a={},b=require("../conf.js").conf(),c=b.logger,e=require("mongoose"),b="mongodb://"+b.MONGO_HOST+":"+b.MONGO_PORT+"/"+b.MONGO_DB_PREFIX+b.env.toLowerCase();e.connect(b);c.info("Connecting to mongo on "+b);exports.loadModel=function(b){a[b]=require("../models/"+b.toLowerCase()+".js").define(e)};exports.model=function(b){a[b]||exports.loadModel(b);return a[b]};exports.find=function(a,b,e){"string"===typeof a&&(a=exports.model(a));a.findById(b,function(a,b){a&&c.error("Error querying db",
a);"function"===typeof e&&e(a,b)})};exports.findAll=function(a,b,e,d,k,m){var l=a&&a.query?parseInt(a.query.page,10)||1:1,q=k?k.limit||20:20;"string"===typeof b&&(b=exports.model(b));b.count(e||{},function(a,g){a&&c.error("Error querying db",a);b.find(e||{},d||{},exports.page(l,k),function(a,b){a&&c.error("Error querying db",a);"function"===typeof m&&m(a,{docs:b,total:g,limit:q,page:l,hasNext:q*l<g,hasPrevious:1<l})})})};exports.page=function(a,b){var c,d;c=b?b.limit||20:20;c={skip:c*(a-1),limit:c};
if(b)for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c}})();(function(){exports.error=function(a){this.respond(a||404,"text/plain","File not found")};exports.html=function(a,b){this.respond(b||200,"text/html",a)};exports.plain=function(a,b){this.respond(b||200,"text/plain",a)};exports.json=function(a,b){this.respond(b||200,"application/json","string"===typeof a?a:JSON.stringify(a))};exports.respond=function(a,b,c){try{this.writeHead(a,{"Content-type":b})}catch(e){console.error("Headers cant be set")}this.end(c)};exports.redirect=function(a){this.writeHead(302,
{Location:a});this.end()}})();(function(){var a=require("./share/slack.js").slack;exports.share=function(b,c,e,g){switch(e.type){case "slack":a(b,c,e,g);return}"function"===typeof g&&g({error:"Social network not found"})}})();(function(){exports.email=function(a){var b,c;if(!a||"string"!==typeof a)return!1;b=a.indexOf("@");c=a.lastIndexOf(".");return 0<b&&3<c&&b<c&&a.length>c+2}})();(function(){exports.define=function(a){return a.model("Customer",new a.Schema({email:String,password:String,firstname:String,lastname:String,key:String,plan:String,img:String,ts_created:{type:Number,"default":Date.now},subscribed:{type:Boolean,"default":!1}}))}})();(function(){exports.define=function(a){return a.model("CustomerHistory",new a.Schema({customer:String,date:{type:Number,"default":Date.now},from_plan:String,to_plan:String}))}})();(function(){exports.define=function(a){return a.model("Document",new a.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(a){return a.model("Filter",new a.Schema({color:String,name:String,building:{type:Boolean,"default":!0},fields:a.Schema.Types.Mixed}))}})();(function(){exports.define=function(a){return a.model("Job",new a.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{doc_title:String,doc_source_id:String,doc_published_date:Number,doc_description:String,doc_source_name:String,doc_source_url:String,doc_source_feed_url:String,doc_description_quality:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){exports.define=function(a){return a.model("SocialAccount",new a.Schema({type:String}))}})();(function(){var a=require("../lib/internet.js");exports.define=function(b){var c=new b.Schema({name:String,url:String,feed_url:{type:String,index:!0},twitter_username:{type:String,index:!0},kind:{type:String,"default":"FEED"},type:{type:String,"default":"CONTENT"},quality:{type:String,"default":"NORMAL"},customer_id:{type:String,index:!0},last:{type:Number},successive_errors:{type:Number,"default":0},fake:{type:Boolean,"default":!1}});b=b.model("Source",c);c.pre("save",function(b){var c=this,h=!1,
f=0,d=function(a){a&&(h=!0);f+=1;2===f&&b(h?Error("Validation error"):null)};a.get(this.url,function(a,b,e){a&&c.invalidate("url","URL is invalid");d(a)});this.feed_url?a.feed(this.feed_url,function(a,b,e){a&&c.invalidate("url","Feed URL is invalid");d(a)}):d()});return b}})();(function(){exports.define=function(a){return a.model("Subscriber",new a.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.define=function(a){return a.model("Target",new a.Schema({filter:String,account:{type:String}}))}})();(function(){exports.campaigns={b:"Blog",r1:"Reddit landing feedback",r2:"Reddit marketing campaign",t1:"Twitter Minethat link",t2:"Twitter xav link",c1:"First marketing campaign",e1:"Xav email footer",e2:"Minethat email footer",e3:"Newsletters"}})();(function(){var a=require("./routes.js").routes,b={},c=require("urlrouter");exports.setup=function(a,b,c,f,d){if("function"!==typeof f[d])throw Error('Route "'+c+'" is invalid:  function "'+d+'" does not exist in controller.');a[b](c,function(a,b,e){0===c.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;f[d](a,b,e)})};exports.route=function(a,c,h){var f=h[1].split(".");b[f[0]]||(b[f[0]]=require("../controllers/"+f[0]+".js"));2>f.length&&(f[1]="index");exports.setup(a,h[0],c,b[f[0]],f[1])};exports.apply=function(b){var c,
h,f;for(c in a)if(a.hasOwnProperty(c))if("string"===typeof a[c][0])exports.route(b,c,a[c]);else for(h=0,f=a[c].length;h<f;h+=1)exports.route(b,c,a[c][h])};exports.router=function(){return c(exports.apply)}})();(function(){exports.add=function(a,b){exports.routes[a]=b};exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/doc/:id":["get","document.display"],"/app/docs":[["get","document.search"],["post","document.search"]],"/app/filter/new":[["get","filter.create"],
["post","filter.create"]],"/app/filters/estimate":["post","filter.estimate"],"/app/filter/wall/:id":["get","filter.wall"],"/app/filter/:id":[["get","filter.edit"],["post","filter.edit"]],"/admin/subscribers":["get","subscriber"],"/admin/subscribers.csv":["get","subscriber.csv"],"/admin/subscriber/:id":["get","subscriber.display"],"/app/jobs":["get","job.index"],"/api/v1/sources":["get","source.index"],"/api/v1/sources/check":["post","source.check"],"/api/v1/sources/import":["post","source.from_feed"],
"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],"/api/v1/source":["post","source.add"],"/api/v1/filters/:id":[["get","filter.edit"],["post","filter.edit"],["delete","filter.remove"]],"/api/v1/document/:id":[["get","document.display"],["delete","document.remove"]],"/api/v1/documents/recent":[["get","document.recent"]],"/api/v1/documents/export":[["get","document.export_bunch"]],"/api/v1/job/:id":["delete","job.remove"],"/api/v1/submit/url":["post",
"submit.url"],"/api/v1/submit/string":["post","submit.string"],"/api/v1/submit/html_string":["post","submit.html_string"],"/":["get","home"],"/devlog":["get","blog"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();(function(){var a=require("../internet.js");exports.share=function(b,c,e){a.postJSON()}})();
