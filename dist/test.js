var util=require("util"),Twitter=require("twitter"),twit=new Twitter({consumer_key:"WO30xPwtmdSOzOmoJ5ruAdeHH",consumer_secret:"IH6UltER7AQsA9Y3vUCDGJxi3AKS4NbzcXDICwBGergu3wJKvm",access_token_key:"58438762-2U1PaQyuvH9DIxcNU40rKxzjmz1klqYSzOlTY8tVk",access_token_secret:"ZGZF2dsQLshYautCNjuxbO7lM6gzRYJVEISDBrc07Kxep"});
(function(b){var a,c,e,f,g=require("./lib/internet.js"),h=0;require("./conf.js").conf(function(d){a=d.logger;c=require("./lib/models.js");f=require("./lib/job.js");e=c.model("Source");setInterval(b.update,"local"===d.env?3E4:1E4);a.log("Aggregator started...");f.init(b.update)});b.submit=function(d,k){f.makeup({customerId:"2c7f9a",gateway:"API",status:"VOID",type:"FEED_URL",value:k.link[0],meta:{doc_description_quality:d.quality,doc_title:k.title[0],doc_published_date:k.date,doc_description:k.desc[0],
doc_source_name:d.name,doc_source_url:d.url,doc_source_feed_url:d.feed_url}},function(d){d&&a.error("Unable to publish job",d)})};b.aggregate=function(d,k){g.feed(d.feed_url,function(c,h){if(c)a.error("Unable to retrieve feed items",c);else{var f=h.items,g,e=0,p=f.length;for(g=0;g<p;g+=1)f[g].date>(d.last||0)&&(b.submit(d,f[g]),f[g].date>e&&(e=f[g].date));0<e&&(d.last=e);k(d)}})};b.check=function(d){b.aggregate(d,function(d){e.update({_id:d._id},{last:d.last},function(d,k,c){d?a.error("Error updating source",
d):0===k&&a.error("Error updating source: no item affected")})})};b.update=function(){e.find({},{},{skip:h,limit:5},function(d,k){if(d)a.error("Error querying db",d);else{var c,g=k.length;if(0===g)h=0;else for(h+=1,c=0;c<g;c+=1)b.check(k[c])}})}})(exports);(function(b){var a=process.env.ENV,c,e=require("fs"),f=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(d){5===d.level?console.error(d.output):console.log(d.output)}}),g=!1,h={loaded:!1,logger:f,env:a};"string"!==typeof a&&(f.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));c=__dirname+"/../../../conf/conf."+a+".sh";
b.parseLine=function(d){0!==d.indexOf("#")&&0<d.indexOf("=")&&(d=d.split("="),h[d[0].trim()]=/^[0-9]+$/ig.test(d[1])?parseInt(d[1],10):d[1].trim())};b.parse=function(d){d=d.split("\n");var k,c=d.length;for(k=0;k<c;k+=1)b.parseLine(d[k])};b.read=function(d){g=!0;e.realpath(c,function(k,a){k&&(f.error("No way to solve path "+c,k),process.exit(1));f.log("Loading configuration at "+a);e.readFile(a,function(k,c){k&&(f.error("No way to load conf",k),process.exit(1));b.parse(c.toString());e.realpath(__dirname+
"/../../",function(k,c){k&&(f.error("No way to get root path",k),process.exit(1));h.root=c;g=!1;h.loaded=!0;f.log("Configuration loaded ...");"function"===typeof d&&d(h)})})});return h};b.wait=function(d){setTimeout(function(){h.loaded?d(h):b.wait(d)},15)};b.conf=function(d){if(h.loaded)return"function"===typeof d&&d(h),h;if(!g)return b.read(d);"function"===typeof d&&b.wait(d);return h}})(exports);(function(){require("./conf.js").conf(function(b){require("./server.js").run(b)})})();(function(b){var a=require("connect"),c=require("serve-static"),e=require("body-parser"),f=require("./lib/blog.js"),g=require("./lib/init.js").initialize,h=require("./routes/router.js").router,d=require("./lib/job.js"),k=require("./controllers/404.js");b.run=function(b){var l=a();l.conf=b;l.logger=b.logger;d.init();f.init(function(){l.use(require("./lib/auth.js").auth);l.use(c(b.WEB_SERVER_STATIC_PATH||__dirname+"/../../dist"));l.use(e({limit:"10mb"}));l.use(g);l.use(h());l.use(k.index);l.listen(b.WEB_SERVER_PORT);
l.logger.log("Server started on "+b.WEB_SERVER_HOST+":"+b.WEB_SERVER_PORT)})}})(exports);(function(b){var a=require("../lib/controller-view.js");b.index=function(c,b,f){c.logger.warn("Page not found: ["+c.method+"] "+c.url);a.view(c,b,"404.html",{value:1E3,url:null},404)}})(exports);(function(){var b=require("../lib/controller-view.js"),a=/<p>([^<]+)/im,c={},e={};exports.add=function(b,g){c[b]=g;var h=a.exec(g);e[b]=h?h[1].split("\n").join(" "):""};exports.index=function(a,g,h){h=[];var d,k;for(d in c)c.hasOwnProperty(d)&&(k=d.split("/devlog/").join("").split(".html").join("").split("-"),h.unshift({url:"/devlog/"+k.join("-")+".html",date:k.splice(0,3).join("/"),title:k.join(" ")}));b.view(a,g,"blog/articles.html",{articles:h})};exports.article=function(a,g,h){h=a.url.split("/devlog/").join("").split(".html").join("").split("-");
b.view(a,g,"blog/article.html",{summary:e[a.url],url:"http://www.minethat.co"+a.url,content:c[a.url]||"Article not found",date:h.splice(0,3).join("/"),title:h.join(" ")})}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(a,c,e){b.findAll(a,c,"Document",null,null,{sort:{"properties.meta.doc_aggregated_date":-1},limit:50},"document/list.html")};exports.recent=function(a,c,e){if(!a.isAPI)return e();b.findAll(a,c,"Document",{status:"MINED"},"properties.meta",{sort:{"properties.meta.doc_aggregated_date":-1},limit:10})};exports.display=function(a,c,e){b.find(a,c,"Document","document/display.html")};exports.remove=function(a,c,e){b.remove(a,c,
"Document")};exports.search=function(a,c,e){e={status:"MINED"};c._data={search:null};"POST"===a.method&&(e["properties.keywords.main"]=a.body.keywords);b.findAll(a,c,"Document",e,null,{sort:{"properties.meta.doc_aggregated_date":-1}},"document/search.html")}})();(function(){var b=require("../lib/controller-view.js");exports.create=function(a,c,e){"GET"===a.method&&b.view(a,c,"filter/edit.html")};exports.estimate=function(a,c,e){b.findAll(a,c,"Document",exports.toCondition(a.body),null,{sort:{"properties.meta.doc_aggregated_date":-1}},"filter/estimation.html")};exports.toCondition=function(a){var c={};a.keywords&&(c["properties.keywords.main"]=a.keywords);return c}})();(function(){var b=require("../lib/controller-view.js"),a=require("../lib/valid.js"),c=require("../lib/mail.js"),e=require("url"),f=require("ua-parser-js"),g=require("../routes/campaigns.js").campaigns;exports.campaign=function(a){var d={ref_campaign:"None",ref_domain:"Unknown"};a.query&&a.query.r&&(d.ref_campaign=g[a.query.r]||a.query.r);a.headers.referer&&(d.ref_domain=e.parse(a.headers.referer).hostname,0===d.ref_domain.indexOf("www.")&&(d.ref_domain=d.ref_domain.substr(4)));return d};exports.index=
function(a,d,k){b.view(a,d,"landing/landing.html",exports.campaign(a))};exports.subscribe=function(c,d,k){k=c.model("Subscriber");if(!c.body||!c.body.email)return d.json({error:"miss_param"},500);if(!a.email(c.body.email))return d.json({error:"invalid_email"},500);k.findOne({email:c.body.email},function(a,k){if(a)return d.json({error:"db_check_failed"},500);if(k)return d.json({status:"exists",id:k._id},200);exports.create(c,d)})};exports.create=function(a,d){var k=a.model("Subscriber"),b=(new f).setUA(a.headers["user-agent"]).getResult()||
{},g=new k({email:a.body.email,ref_campaign:a.body.ref_campaign,ref_domain:a.body.ref_domain,browser:b.browser&&b.browser.name?b.browser.name:"Unknown",os:b.os&&b.os.name?b.os.name:"Unknown",device:b.device&&b.device.vendor?b.device.vendor+" / "+(b.device.model||"Unknown"):"Unknown"});g.save(function(k){if(k)return d.json({error:"db_save_failed"},500);c.template(a.body.email,"You're in!","landing-subscribed.html",{sub:g});c.template("xav@minethat.co","He's in!","landing-subscribed-alert.html",{sub:g});
d.json({status:"success"})})}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(a,c,e){b.findAll(a,c,"Job",null,null,null,"job/list.html")};exports.remove=function(a,c,e){b.remove(a,c,"Job")}})();(function(){var b=require("../lib/controller-view.js"),a=require("../lib/internet.js");exports.index=function(a,e,f){b.findAll(a,e,"Source",null,null,null,"source/list.html")};exports.display=function(a,e,f){b.find(a,e,"Source","source/edit.html")};exports.from_feed=function(c,e,f){"GET"===c.method?!1===c.isAPI?b.view(c,e,"source/from_feed.html"):e.json({status:"error",error:"Unauthorized method"},401):a.feed(c.body.feed_url,function(a,h,d){if(!a&&h&&d){var k;console.log(h.metadata);"string"===typeof h.metadata.url?
k=h.metadata.url:Array.isArray(h.metadata.url)?(a=h.metadata.url[0],"string"===typeof a?k=a:a.href&&(k=a.href)):c.logger.warn("Unable to detect site url for feed",h.metadata);c.body.name=h.metadata.title;c.body.url=k;exports.add(c,e,f)}else!1===c.isAPI?b.view(c,e,"source/from_feed.html",{error:"Invalid feed"}):e.json({status:"error",error:"Invalid feed"},422)})};exports.add=function(a,e,f){b.create(a,e,"Source","source/edit.html","/app/source/:id")};exports.edit=function(a,e,f){b.edit(a,e,"Source",
"source/edit.html")};exports.check=function(b,e,f){a.feed(b.body.feed_url,function(a,h){a||!h?e.json({status:"error",error:"Invalid feed"},422):b.findAll(b,"Source",{feed_url:b.body.feed_url},null,null,function(d,a){d?e.json({status:"error",error:"Internal error"},500):0===a.total?e.json({status:"success"},200):e.json({status:"exists"},409)})})};exports.remove=function(a,e,f){b.remove(a,e,"Source")}})();(function(){var b=require("../lib/job.js");exports.html_string=function(a,b,e){if(!a.body.content)return b.json({status:"error",error:'Missing "content" parameter'},500);exports.submit(a,b,"HTML_STRING",a.body.content)};exports.string=function(a,b,e){if(!a.body||!a.body.string)return b.json({status:"error",error:'Missing "string" parameter'},500);exports.submit(a,b,"STRING",a.body.string)};exports.url=function(a,b,e){if(!a.body||!a.body.url)return b.json({status:"error",error:'Missing "url" parameter'},
500);exports.submit(a,b,"URL",a.body.url)};exports.submit=function(a,c,e,f){console.log("[API] Got request");var g={customerId:"2c7f9a",gateway:"API",status:"VOID",type:e,value:f};a.body.meta&&(g.meta=a.body.meta);if(a.body.target&&"TRAIN"===a.body.target){if(!a.body||!a.body.classes)return c.json({status:"error",error:'Missing "classes" parameter'},500);g.target="TRAIN";g.classes=a.body.classes}b.makeup(g,function(a){return a?c.json({status:"error",error:"DB error"},500):c.json({status:"success",
job:g._id})})}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(a,c,e){b.findAll(a,c,"Subscriber",null,null,null,"subscriber/list.html")};exports.display=function(a,c,e){b.find(a,c,"Subscriber","subscriber/display.html")};exports.csv=function(a,c,e){b.find(a,c,"Subscriber","subscriber/display.html")}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(a,c){var e=a.model("Subscriber");if(!a.query.id)return c.error("Missing param for unsubscription",500);e.findById(a.query.id,function(f,g){var h=null;if(f)return c.error("DB query error",500);a.query.action&&("unsubscribe"===a.query.action?(g.unactivated=!0,h="Done! You won't receive our newsletter anymore."):(g.unactivated=!1,h="Thanks! You're now subscribed to our newsletter!"),g.save());b.view(a,c,"subscriber/subscription.html",
{msg:h,sub:g})})}})();(function(){var b=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(a,c,e){0===a._parsedUrl.href.indexOf("/private")||0===a._parsedUrl.href.indexOf("/admin")||0===a._parsedUrl.href.indexOf("/app")?b.check(a,c,function(a){e()}):e()}})();(function(){var b=require("fs"),a=require("../routes/routes.js"),c=require("../controllers/blog.js"),e=require("marked"),f=require("../conf.js").conf();exports.add=function(g){if("."!==g.substring(0,1)||"local"===f.env){var h=g.split(".md").join("");a.add("/devlog/"+h+".html",["get","blog.article"]);b.readFile(f.root+"/src/blog/"+g,function(d,a){d?f.logger.error("Unable to read blog article"+f.root+"/src/blog/"+g,d):e(a.toString(),{},function(d,a){d?f.logger.error("Unable to convert blog article"+
f.root+"/src/blog/"+g,d):c.add("/devlog/"+h+".html",a)})})}};exports.init=function(a){b.readdir(f.root+"/src/blog/",function(b,d){if(b)f.logger.error('Blog files not found at "'+f.root+'/src/blog/"',b);else{var k,c=d.length;for(k=0;k<c;k+=1)-1<d[k].indexOf(".md")&&exports.add(d[k]);"function"===typeof a&&a()}})}})();(function(){var b=require("ejs"),a=require("fs"),c=require("async"),e=require("../conf.js").conf(),f=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,g={},h={leadingZero:function(d){return 10>d?"0"+d:d},tsToReadable:function(d){d=new Date(d);return d.getMonth()+1+"/"+d.getDate()+"/"+d.getUTCFullYear()+", "+h.leadingZero(d.getHours())+":"+h.leadingZero(d.getMinutes())}};exports.remove=function(d,a,b,c){d.isAPI?d.model(b).findById(d.params.id,function(d,b){d||null===b?a.json({status:"error",error:"Resource not found"},
404):b.remove(function(d){d?a.json({status:"error",error:"Resource not deleted"},500):a.json({status:"success"},200)})}):a.error(404,"Only available through API")};exports.save=function(d,a,b,c,g){var f=new (d.model(b))(d.body),h=!1;f.save(function(b){var e={status:b?"error":"success",doc:f.toObject()};h||(h=!0,b&&(e.error={message:b}),d.isAPI?a.json(e,b?500:200):g?a.redirect(g.split(":id").join(f._id)):exports.view(d,a,c,e))})};exports.create=function(d,a,b,c,g){var f=d.model(b);"POST"===d.method?
exports.save(d,a,b,c,g):d.isAPI?a.json({error:"Not implemented"},500):exports.view(d,a,c,{doc:new f,status:"create"})};exports.find=function(a,b,c,g){a.find(c,a.params.id,function(c,f){if(c)return b.error(500);f?a.isAPI?b.json(f.toObject()):exports.view(a,b,g,{doc:f,status:"exists"}):a.isAPI?b.json({status:"error",error:"Resource not found"},404):b.error(404)})};exports.edit=function(a,b,c,g){"GET"===a.method?exports.find(a,b,c,g):a.model(c).update({_id:a.params.id},a.body,function(f,h,e){if(f)return b.error(500);
a.find(c,a.params.id,function(c,f){if(c)return b.error(500);f?a.isAPI?b.json(f):exports.view(a,b,g,{doc:f,status:"exists"}):a.isAPI?b.json({status:"error",error:"Resource not found"},404):b.error(404)})})};exports.findAll=function(a,b,c,g,f,h,e){a.findAll(a,c,g,f,h,function(c,g){if(c)return b.error(404);a.isAPI?b.json(g):exports.view(a,b,e,g)})};exports.requiresLoading=function(a){return!g[a]||"local"===e.env};exports.load=function(b,c){a.readFile(__dirname+"/../views/"+b,function(a,f){a?(e.logger.error("File not found: views/"+
b),g[b]="Template not found"):g[b]=f.toString();var h=exports.detectPartials(b);0<h.length?exports.loadPartials(h,c):"function"===typeof c&&c()})};exports.render=function(a,c){try{return b.render(g[a],{data:c?c:{},partial:exports.partial,env:e.env,utils:h})}catch(f){return e.logger.error("Unable to render template",f),null}};exports.view=function(a,b,c,g,f){exports.renderView(c,g,function(a){b.html(a,f)})};exports.renderView=function(a,b,c){var g=function(){c(exports.render(a,b))};if(exports.requiresLoading(a))return exports.load(a,
g);g()};exports.partial=function(a,c){var f={data:c};f.env=e.env;f.partial=exports.partial;f.utils=h;return b.render(g["_partials/"+a+".html"],f)};exports.loadPartials=function(a,b){var f,g=a.length,h=[];for(f=0;f<g;f+=1)h.push(exports.loadPartial(a[f]));c.parallel(h,b)};exports.loadPartial=function(a){return function(b){exports.load("_partials/"+a+".html",b)}};exports.detectPartials=function(a){for(var b=[],c;;){c=f.exec(g[a]);if(!c)break;b.push(c[1])}return b}})();(function(b){var a=require("../conf.js").conf(),c=require("./respond.js"),e=require("./models.js"),f=require("qs");b.initialize=function(b,h,d){var k;b.logger=a.logger;b.query=f.parse(b._parsedUrl.query);for(k in e)e.hasOwnProperty(k)&&(b[k]?a.logger.error("Injection failed: key "+k+"already defined in Request object"):b[k]=e[k]);for(k in c)c.hasOwnProperty(k)&&(h[k]?a.logger.error("Injection failed: key "+k+"already defined in Response object"):h[k]=c[k]);d()}})(exports);(function(b){var a=require("request"),c=require("../conf.js").conf().logger,e=require("blindparser");b.get=function(b,g){try{a({url:b,followAllRedirects:!0},function(a,h){!a&&200<=h.statusCode&&300>h.statusCode?g(null,h.body):(c.warn("URL is invalid: "+a,h?h.statusCode:h,b),g(a))})}catch(h){c.warn("URL is invalid",b,h),g(h)}};b.feed=function(a,g){b.get(a,function(b,d){if(b)g(b);else try{e.parseString(d,{},function(b,d){b?(c.warn("URL "+a+" feed is invalid: "+b),g(b)):g(null,d,a)})}catch(k){g(k)}})}})(exports);(function(){var b=require("amqp"),a=require("../conf.js").conf(),c=!1,e=require("./models.js"),f;exports.init=function(g){f=b.createConnection({host:a.RABBIT_HOST,port:a.RABBIT_PORT});f.on("ready",function(){a.logger.log("[RabbitMQ] Connection established");f.queue(a.RABBIT_EXTRACT_QUEUE,{durable:!0,exclusive:!1,autoDelete:!1},function(a){console.log("[RabbitMQ] Queue declared");c=!0;"function"===typeof g&&(g(),g=null)})});f.on("error",function(){c=!1;console.log("[RabbitMQ] Error",arguments)})};
exports.makeup=function(a,b){var c=new (e.model("Job"))(a);c.save(function(a){a||exports.publish(c._id);"function"===typeof b&&b(a,c)})};exports.publish=function(b){c?(a.logger.log("[RabbitMQ] Submitted job "+b),f.publish("extract",b)):setTimeout(function(){exports.publish(b)},100)}})();(function(){module.exports=function(b,a){if(b===a)return 0;var c=b.length,e=a.length,f=0,g=0,h,d,k,m,l=[];if(c&&e){for(;f<c;)f+=1,l[f]=f;for(;g<e;)for(m=a.charCodeAt(g),h=g,d=g+=1,f=0;f<c;f+=1)k=h+(b.charCodeAt(f)===m?0:1),h=l[f],d=d<h?d<k?d+1:k:h<k?h+1:k,l[f]=d;return d}return c+e}})();(function(){var b,a=require("html-to-text"),c=require("./controller-view.js"),e=require("../conf.js").conf(),f=e.logger,g=require("nodemailer");exports.html=function(c,d,k,m,l){b||(b=g.createTransport("SMTP",{service:"Gmail",auth:{user:e.WEB_EMAIL_USER,pass:e.WEB_EMAIL_PASS}}));f.debug("Sending message to: "+c+" (Subject: "+d+")");b.sendMail({from:m||"Xav from Minethat <xav@minethat.co>",to:c,subject:d,text:l||a.fromString(k),html:k},function(a,b){a?f.error(a):f.debug("Message sent to "+c+"/"+b.message)})};
exports.template=function(a,b,f,g,e,n){c.renderView("emails/"+f,g,function(c){exports.html(a,b,c,e,n)})}})();(function(){var b={},a=require("../conf.js").conf(),c=a.logger,e=require("mongoose"),a="mongodb://"+a.MONGO_HOST+":"+a.MONGO_PORT+"/"+a.MONGO_DB_PREFIX+a.env.toLowerCase();e.connect(a);c.info("Connecting to mongo on "+a);exports.loadModel=function(a){b[a]=require("../models/"+a.toLowerCase()+".js").define(e)};exports.model=function(a){b[a]||exports.loadModel(a);return b[a]};exports.find=function(a,b,h){"string"===typeof a&&(a=exports.model(a));a.findById(b,function(a,b){a&&c.error("Error querying db",
a);"function"===typeof h&&h(a,b)})};exports.findAll=function(a,b,h,d,e,m){var l=a.query?parseInt(a.query.page,10)||1:1,n=e?e.limit||20:20;"string"===typeof b&&(b=exports.model(b));b.count(h||{},function(a,f){a&&c.error("Error querying db",a);b.find(h||{},d||{},exports.page(l,e),function(a,b){a&&c.error("Error querying db",a);"function"===typeof m&&m(a,{docs:b,total:f,limit:n,page:l,hasNext:n*l<f,hasPrevious:1<l})})})};exports.page=function(a,b){var c,d;c=b?b.limit||20:20;c={skip:c*(a-1),limit:c};
if(b)for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c}})();(function(){exports.error=function(b){this.respond(b||404,"text/plain","File not found")};exports.html=function(b,a){this.respond(a||200,"text/html",b)};exports.plain=function(b,a){this.respond(a||200,"text/plain",b)};exports.json=function(b,a){this.respond(a||200,"application/json","string"===typeof b?b:JSON.stringify(b))};exports.respond=function(b,a,c){this.writeHead(b,{"Content-type":a});this.end(c)};exports.redirect=function(b){this.writeHead(302,{Location:b});this.end()}})();(function(){var b=require("./share/slack.js").slack;exports.share=function(a,c,e){switch(c.type){case "slack":b(a,c,e);return}"function"===typeof e&&e({error:"Social network not found"})}})();(function(){exports.email=function(b){var a,c;if(!b||"string"!==typeof b)return!1;a=b.indexOf("@");c=b.lastIndexOf(".");return 0<a&&3<c&&a<c&&b.length>c+2}})();(function(){exports.define=function(b){return b.model("Document",new b.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(b){return b.model("Document",new b.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(b){return b.model("Job",new b.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{doc_title:String,doc_published_date:Number,doc_description:String,doc_source_name:String,doc_source_url:String,doc_source_feed_url:String,doc_description_quality:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){var b=require("../lib/internet.js");exports.define=function(a){var c=new a.Schema({name:String,url:String,feed_url:{type:String,index:!0},type:{type:String,"default":"CONTENT"},quality:{type:String,"default":"NORMAL"},customer_id:{type:String,index:!0},last:{type:Number},fake:{type:Boolean,"default":!1}});a=a.model("Source",c);c.pre("save",function(a){var c=this,g=!1,h=0,d=function(b){b&&(g=!0);h+=1;2===h&&a(g?Error("Validation error"):null)};b.get(this.url,function(a,b,e){a&&c.invalidate("url",
"URL is invalid");d(a)});this.feed_url?b.feed(this.feed_url,function(a,b,e){a&&c.invalidate("url","Feed URL is invalid");d(a)}):d()});return a}})();(function(){exports.define=function(b){return b.model("Subscriber",new b.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.campaigns={b:"Blog",r1:"Reddit landing feedback",r2:"Reddit marketing campaign",t1:"Twitter Minethat link",t2:"Twitter xav link",c1:"First marketing campaign",e1:"Xav email footer",e2:"Minethat email footer",e3:"Newsletters"}})();(function(){var b=require("./routes.js").routes,a={},c=require("urlrouter");exports.setup=function(a,b,c,h,d){if("function"!==typeof h[d])throw Error('Route "'+c+'" is invalid:  function "'+d+'" does not exist in controller.');a[b](c,function(a,b,f){0===c.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;h[d](a,b,f)})};exports.route=function(b,c,g){var h=g[1].split(".");a[h[0]]||(a[h[0]]=require("../controllers/"+h[0]+".js"));2>h.length&&(h[1]="index");exports.setup(b,g[0],c,a[h[0]],h[1])};exports.apply=function(a){var c,
g,h;for(c in b)if(b.hasOwnProperty(c))if("string"===typeof b[c][0])exports.route(a,c,b[c]);else for(g=0,h=b[c].length;g<h;g+=1)exports.route(a,c,b[c][g])};exports.router=function(){return c(exports.apply)}})();(function(){exports.add=function(b,a){exports.routes[b]=a};exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/doc/:id":["get","document.display"],"/app/docs":[["get","document.search"],["post","document.search"]],"/app/filters/new":[["get","filter.create"],
["post","filter.create"]],"/app/filters/estimate":["post","filter.estimate"],"/app/jobs":["get","job.index"],"/admin/subscribers":["get","subscriber"],"/admin/subscribers.csv":["get","subscriber.csv"],"/admin/subscriber/:id":["get","subscriber.display"],"/api/v1/sources":["get","source.index"],"/api/v1/sources/check":["post","source.check"],"/api/v1/sources/import":["post","source.from_feed"],"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],"/api/v1/source":["post",
"source.add"],"/api/v1/document/:id":[["get","document.display"],["delete","document.remove"]],"/api/v1/documents/recent":[["get","document.recent"]],"/api/v1/job/:id":["delete","job.remove"],"/api/v1/submit/url":["post","submit.url"],"/api/v1/submit/string":["post","submit.string"],"/api/v1/submit/html_string":["post","submit.html_string"],"/":["get","home"],"/devlog":["get","blog"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();(function(){var b=require("../internet.js");exports.share=function(a,c,e){b.postJSON()}})();
