(function(){var a,b,e,f=require("./lib/internet.js"),g=0;exports.aggregate=function(d,c){f.feed(d.feed_url,function(h,a){var e=a.items,b,g=0,f=e.length;for(b=0;b<f;b+=1)e[b].date>(d.last||0)&&(console.log(e[b].title),e[b].date>g&&(g=e[b].date));0<g&&(d.last=g);c(d)})};exports.check=function(d){exports.aggregate(d,function(c){e.update({_id:c._id},{last:c.last},function(c,d,e){c?a.error("Error updating source",c):0===d&&a.error("Error updating source: no item affected")})})};exports.sources=function(){e.find({},
{},{skip:g,limit:1},function(d,c){if(d)a.error("Error querying db",d);else{var h,e=c.length;if(0===e)g=0;else for(g+=1,h=0;h<e;h+=1)exports.check(c[h])}})};require("./conf.js").conf(function(d){a=d.logger;b=require("./lib/models.js");e=b.model("Source");setInterval(function(){exports.sources()},3E4);exports.sources()})})();(function(){var a=process.env.ENV,b,e=require("fs"),f=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(d){5===d.level?console.error(d.output):console.log(d.output)}}),g={loaded:!1,logger:f,env:a};"string"!==typeof a&&(f.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));b=__dirname+"/../../../conf/conf."+a+".sh";exports.parseLine=
function(d){0!==d.indexOf("#")&&0<d.indexOf("=")&&(d=d.split("="),g[d[0]]=/^[0-9]+$/ig.test(d[1])?parseInt(d[1],10):d[1])};exports.parse=function(d){d=d.split("\n");var c,h=d.length;for(c=0;c<h;c+=1)exports.parseLine(d[c])};exports.read=function(d){g.loaded=!0;e.readFile(b,function(c,h){c&&(f.error("No way to load conf",c),process.exit(1));exports.parse(h.toString());e.realpath(__dirname+"/../../",function(c,h){c&&(f.error("No way to get root path",c),process.exit(1));g.root=h;"function"===typeof d&&
d(g)})});return g};exports.conf=function(d){return g.loaded?g:exports.read(d)}})();(function(){require("./conf.js").conf(function(a){require("./server.js").run(a)})})();(function(){var a=require("connect"),b=require("serve-static"),e=require("body-parser"),f=require("./lib/blog.js"),g=require("./lib/init.js").initialize,d=require("./routes/router.js").router,c=require("./controllers/404.js"),h;exports.run=function(k){h=a();h.conf=k;h.logger=k.logger;f.init();h.use(require("./lib/auth.js").auth);h.use(b(k.WEB_SERVER_STATIC_PATH||__dirname+"/../../dist"));h.use(e());h.use(g);h.use(d());h.use(c.index);h.listen(k.WEB_SERVER_PORT);h.logger.log("Server started on "+k.WEB_SERVER_HOST+
":"+k.WEB_SERVER_PORT)}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,e,f){b.logger.error("Page not found: "+b.url);a.view(b,e,"404.html")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,e,f){a.findAll(b,e,"Document",null,null,null,"document/list.html")};exports.display=function(b,e,f){a.find(b,e,"Document","document/display.html")};exports.remove=function(b,e,f){a.remove(b,e,"Document")}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/valid.js"),e=require("../lib/mail.js"),f=require("url"),g=require("ua-parser-js"),d=require("../routes/campaigns.js").campaigns;exports.campaign=function(c){var h={ref_campaign:"None",ref_domain:"Unknown"};c.query&&c.query.r&&(h.ref_campaign=d[c.query.r]||c.query.r);c.headers.referer&&(h.ref_domain=f.parse(c.headers.referer).hostname,0===h.ref_domain.indexOf("www.")&&(h.ref_domain=h.ref_domain.substr(4)));return h};exports.index=
function(c,h,d){a.view(c,h,"landing/landing.html",exports.campaign(c))};exports.subscribe=function(c,h,d){d=c.model("Subscriber");if(!c.body||!c.body.email)return h.json({error:"miss_param"},500);if(!b.email(c.body.email))return h.json({error:"invalid_email"},500);d.findOne({email:c.body.email},function(d,a){if(d)return h.json({error:"db_check_failed"},500);if(a)return h.json({status:"exists",id:a._id},200);exports.create(c,h)})};exports.create=function(c,h){var d=c.model("Subscriber"),a=(new g).setUA(c.headers["user-agent"]).getResult()||
{},b=new d({email:c.body.email,ref_campaign:c.body.ref_campaign,ref_domain:c.body.ref_domain,browser:a.browser&&a.browser.name?a.browser.name:"Unknown",os:a.os&&a.os.name?a.os.name:"Unknown",device:a.device&&a.device.vendor?a.device.vendor+" / "+(a.device.model||"Unknown"):"Unknown"});b.save(function(a){if(a)return h.json({error:"db_save_failed"},500);e.template(c.body.email,"You're in!","landing-subscribed.html",{sub:b});e.template("xav@minethat.co","He's in!","landing-subscribed-alert.html",{sub:b});
h.json({status:"success"})})}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/internet.js");exports.index=function(e,b,g){a.findAll(e,b,"Source",null,null,null,"source/list.html")};exports.display=function(b,f,g){a.find(b,f,"Source","source/edit.html")};exports.from_feed=function(e,f,g){"GET"===e.method?a.view(e,f,"source/from_feed.html"):b.feed(e.body.feed_url,function(d,c){d||!c?a.view(e,f,"source/from_feed.html",{error:"Invalid feed"}):(e.body.name=c.metadata.title,e.body.url=c.metadata.url,exports.add(e,
f,g))})};exports.add=function(b,f,g){a.create(b,f,"Source","source/edit.html","/app/source/:id")};exports.edit=function(b,f,g){a.edit(b,f,"Source","source/edit.html")};exports.check=function(a,f,g){b.feed(a.body.feed_url,function(d,c){d||!c?f.json({status:"error",error:"Invalid feed"},422):a.findAll(a,"Source",{feed_url:a.body.feed_url},null,null,function(c,a){c?f.json({status:"error",error:"Internal error"},500):(console.log(a),0===a.total?f.json({status:"success"},200):f.json({status:"exists"},
409))})})};exports.remove=function(b,f,g){a.remove(b,f,"Source")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,e,f){a.findAll(b,e,"Subscriber",null,null,null,"subscriber/list.html")};exports.display=function(b,e,f){a.find(b,e,"Subscriber","subscriber/display.html")};exports.csv=function(b,e,f){a.find(b,e,"Subscriber","subscriber/display.html")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,e){var f=b.model("Subscriber");if(!b.query.id)return e.error("Missing param for unsubscription",500);f.findById(b.query.id,function(g,d){var c=null;if(g)return e.error("DB query error",500);b.query.action&&("unsubscribe"===b.query.action?(d.unactivated=!0,c="Done! You won't receive our newsletter anymore."):(d.unactivated=!1,c="Thanks! You're now subscribed to our newsletter!"),d.save());a.view(b,e,"subscriber/subscription.html",
{msg:c,sub:d})})}})();(function(){var a=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(b,e,f){0===b._parsedUrl.href.indexOf("/private")||0===b._parsedUrl.href.indexOf("/admin")||0===b._parsedUrl.href.indexOf("/app")?a.check(b,e,function(a){f()}):f()}})();(function(){var a=require("fs"),b=require("../conf.js").conf();exports.init=function(e,f){a.readdir(b.root+"src/blog/",function(a,d){a||console.log(d)})}})();(function(){var a=require("ejs"),b=require("fs"),e=require("async"),f=require("../conf.js").conf(),g=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,d={};exports.remove=function(c,h,a,d){c.isAPI?c.model(a).findById(c.params.id,function(c,a){c||null===a?h.json({status:"error",error:"Resource not found"},404):a.remove(function(c){c?h.json({status:"error",error:"Resource not deleted"},500):h.json({status:"success"},200)})}):h.error(404,"Only available through API")};exports.save=function(c,h,a,
d,b){var g=new (c.model(a))(c.body),e=!1;g.save(function(a){var f={status:a?"success":"error",doc:g.toObject()};e||(e=!0,a&&(f.error={message:a}),c.isAPI?h.json(f,a?500:200):b?h.redirect(b.split(":id").join(g._id)):exports.view(c,h,d,f))})};exports.create=function(c,a,d,b,g){var e=c.model(d);"POST"===c.method?exports.save(c,a,d,b,g):c.isAPI?a.json({error:"Not implemented"},500):exports.view(c,a,b,{doc:new e,status:"create"})};exports.find=function(c,a,d,b){c.find(d,c.params.id,function(d,g){if(d)return a.error(500);
g?c.isAPI?a.json(g):exports.view(c,a,b,{doc:g,status:"exists"}):c.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})};exports.edit=function(c,a,d,b){"GET"===c.method?exports.find(c,a,d,b):c.model(d).update({_id:c.params.id},c.body,function(g,e,f){if(g)return a.error(500);c.find(d,c.params.id,function(d,g){if(d)return a.error(500);g?c.isAPI?a.json(g):exports.view(c,a,b,{doc:g,status:"exists"}):c.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})})};
exports.findAll=function(c,a,d,b,g,e,f){c.findAll(c,d,b,g,e,function(d,b){if(d)return a.error(404);c.isAPI?a.json(b):exports.view(c,a,f,b)})};exports.requiresLoading=function(c){return!d[c]||"local"===f.env};exports.load=function(c,a){b.readFile(__dirname+"/../views/"+c,function(b,g){b?(f.logger.error("File not found: views/"+c),d[c]="Template not found"):d[c]=g.toString();var e=exports.detectPartials(c);0<e.length?exports.loadPartials(e,a):"function"===typeof a&&a()})};exports.render=function(c,
b){return a.render(d[c],{data:b?b:{},partial:exports.partial})};exports.view=function(a,d,b,g){exports.renderView(b,g,function(a){d.html(a)})};exports.renderView=function(a,d,b){var g=function(){b(exports.render(a,d))};if(exports.requiresLoading(a))return exports.load(a,g);g()};exports.partial=function(c,b){return a.render(d["_partials/"+c+".html"],b)};exports.loadPartials=function(a,d){var b,g=a.length,f=[];for(b=0;b<g;b+=1)f.push(exports.loadPartial(a[b]));e.parallel(f,d)};exports.loadPartial=function(a){return function(b){exports.load("_partials/"+
a+".html",b)}};exports.detectPartials=function(a){for(var b=[],e;;){e=g.exec(d[a]);if(!e)break;b.push(e[1])}return b}})();(function(){var a=require("../conf.js").conf(),b=require("./respond.js"),e=require("./models.js"),f=require("qs");exports.initialize=function(g,d,c){var h;g.logger=a.logger;g.query=f.parse(g._parsedUrl.query);for(h in e)e.hasOwnProperty(h)&&(g[h]?a.logger.error("Injection failed: key "+h+"already defined in Request object"):g[h]=e[h]);for(h in b)b.hasOwnProperty(h)&&(d[h]?a.logger.error("Injection failed: key "+h+"already defined in Response object"):d[h]=b[h]);c()}})();(function(){var a=require("request"),b=require("blindparser");exports.get=function(b,f){a(b,function(a,b){a||200!==b.statusCode?f(a):f(null,b.body,b.href)})};exports.feed=function(a,f){exports.get(a,function(a,d,c){if(a)f(a);else try{b.parseString(d,{},function(a,c){a?f(a):f(null,c)})}catch(e){f(e)}})}})();(function(){var a,b=require("html-to-text"),e=require("./controller-view.js"),f=require("../conf.js").conf(),g=f.logger,d=require("nodemailer");exports.html=function(c,e,k,m,l){a||(a=d.createTransport("SMTP",{service:"Gmail",auth:{user:f.WEB_EMAIL_USER,pass:f.WEB_EMAIL_PASS}}));a.sendMail({from:m||"Xav from Minethat <xav@minethat.co>",to:c,subject:e,text:l||b.fromString(k),html:k},function(a,c){a?g.error(a):g.debug("Message sent: "+c.message)})};exports.template=function(a,b,d,g,f,n){e.renderView("emails/"+
d,g,function(d){exports.html(a,b,d,f,n)})}})();(function(){var a={},b=require("../conf.js").conf(),e=b.logger,f=require("mongoose");f.connect("mongodb://"+b.MONGO_HOST+":"+b.MONGO_PORT+"/"+b.MONGO_DB_PREFIX+b.env.toLowerCase());exports.loadModel=function(b){a[b]=require("../models/"+b.toLowerCase()+".js").define(f)};exports.model=function(b){a[b]||exports.loadModel(b);return a[b]};exports.find=function(a,b,c){"string"===typeof a&&(a=exports.model(a));a.findById(b,function(a,b){a&&e.error("Error querying db",a);"function"===typeof c&&c(a,b)})};
exports.findAll=function(a,b,c,f,k,m){var l=a.query?parseInt(a.query.page,10)||1:1;"string"===typeof b&&(b=exports.model(b));b.count(c||{},function(a,g){a&&e.error("Error querying db",a);b.find(c||{},f||{},exports.page(l,k),function(a,b){a&&e.error("Error querying db",a);"function"===typeof m&&m(a,{docs:b,total:g,limit:20,page:l,hasNext:20*l<g,hasPrevious:1<l})})})};exports.page=function(a,b){var c,e;c={skip:20*(a-1),limit:20};if(b)for(e in b)b.hasOwnProperty(e)&&(c[e]=b[e]);return c}})();(function(){exports.error=function(a){this.respond(a||404,"text/plain","File not found")};exports.html=function(a,b){this.respond(b||200,"text/html",a)};exports.plain=function(a,b){this.respond(b||200,"text/plain",a)};exports.json=function(a,b){this.respond(b||200,"application/json","string"===typeof a?a:JSON.stringify(a))};exports.respond=function(a,b,e){this.writeHead(a,{"Content-type":b});this.end(e)};exports.redirect=function(a){this.writeHead(302,{Location:a});this.end()}})();(function(){exports.email=function(a){var b,e;if(!a||"string"!==typeof a)return!1;b=a.indexOf("@");e=a.lastIndexOf(".");return 0<b&&3<e&&b<e&&a.length>e+2}})();(function(){exports.define=function(a){return a.model("Document",new a.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(a){return a.model("Job",new a.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{url:String,title:String,author:String,organization:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){var a=require("../lib/internet.js");exports.define=function(b){var e=new b.Schema({name:String,url:String,feed_url:{type:String,index:!0},type:{type:String,"default":"CONTENT"},customer_id:{type:String,index:!0},last:{type:Number}});b=b.model("Source",e);e.pre("save",function(b){var e=this,d=!1,c=0,h=function(a){a&&(d=!0);c+=1;2===c&&b(d?Error("Validation error"):null)};a.get(this.url,function(a,b,c){a&&e.invalidate("url","URL is invalid");h(a)});a.feed(this.feed_url,function(a,b,c){a&&
e.invalidate("url","Feed URL is invalid");h(a)})});return b}})();(function(){exports.define=function(a){return a.model("Subscriber",new a.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.campaigns={b:"Blog",r1:"Reddit landing feedback",r2:"Reddit marketing campaign",t1:"Twitter Minethat link",t2:"Twitter xav link",c1:"First marketing campaign",e1:"Xav email footer",e2:"Minethat email footer",e3:"Newsletters"}})();(function(){var a=require("./routes.js").routes,b={},e=require("urlrouter");exports.setup=function(a,b,d,c,e){if("function"!==typeof c[e])throw Error('Route "'+d+'" is invalid:  function "'+e+'" does not exist in controller.');a[b](d,function(a,b,g){0===d.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;c[e](a,b,g)})};exports.route=function(a,e,d){var c=d[1].split(".");b[c[0]]||(b[c[0]]=require("../controllers/"+c[0]+".js"));2>c.length&&(c[1]="index");exports.setup(a,d[0],e,b[c[0]],c[1])};exports.apply=function(b){var e,
d,c;for(e in a)if(a.hasOwnProperty(e))if("string"===typeof a[e][0])exports.route(b,e,a[e]);else for(d=0,c=a[e].length;d<c;d+=1)exports.route(b,e,a[e][d])};exports.router=function(){return e(exports.apply)}})();(function(){exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/document/:id":["get","document.display"],"/admin/subscribers":["get","subscriber"],"/admin/subscribers.csv":["get","subscriber.csv"],"/admin/subscriber/:id":["get","subscriber.display"],
"/api/v1/sources":["get","source.index"],"/api/v1/sources/check":["post","source.check"],"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],"/api/v1/source":["post","source.add"],"/":["get","home"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();
