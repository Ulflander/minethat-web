(function(a){var b,f,g,d,e=require("./lib/internet.js"),c=0;require("./conf.js").conf(function(c){b=c.logger;f=require("./lib/models.js");d=require("./lib/job.js");g=f.model("Source");setInterval(a.update,"local"===c.env?3E4:1E4);a.update()});a.submit=function(c,h){console.log(h);d.makeup({customerId:"2c7f9a",gateway:"API",status:"VOID",type:"feed_url",value:h.link[0],meta:{doc_title:h.title[0],doc_published_date:h.date,doc_description:h.desc[0],doc_source_name:c.name,doc_source_url:c.url,doc_source_feed_url:c.feed_url}},
function(c){c?b.error("Unable to publish job",c):b.info("Job published: "+h.title[0])})};a.aggregate=function(c,h){e.feed(c.feed_url,function(b,f){var e=f.items,d,g=0,p=e.length;for(d=0;d<p;d+=1)e[d].date>(c.last||0)&&(a.submit(c,e[d]),e[d].date>g&&(g=e[d].date));0<g&&(c.last=g);h(c)})};a.check=function(c){a.aggregate(c,function(c){g.update({_id:c._id},{last:c.last},function(c,k,h){c?b.error("Error updating source",c):0===k&&b.error("Error updating source: no item affected")})})};a.update=function(){g.find({},
{},{skip:c,limit:5},function(k,h){if(k)b.error("Error querying db",k);else{var f,d=h.length;if(0===d)c=0;else for(c+=1,f=0;f<d;f+=1)a.check(h[f])}})}})(exports);(function(a){var b=process.env.ENV,f,g=require("fs"),d=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(c){5===c.level?console.error(c.output):console.log(c.output)}}),e={loaded:!1,logger:d,env:b};"string"!==typeof b&&(d.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));f=__dirname+"/../../../conf/conf."+b+".sh";a.parseLine=
function(c){0!==c.indexOf("#")&&0<c.indexOf("=")&&(c=c.split("="),e[c[0]]=/^[0-9]+$/ig.test(c[1])?parseInt(c[1],10):c[1])};a.parse=function(c){c=c.split("\n");var k,h=c.length;for(k=0;k<h;k+=1)a.parseLine(c[k])};a.read=function(c){e.loaded=!0;g.readFile(f,function(k,h){k&&(d.error("No way to load conf",k),process.exit(1));a.parse(h.toString());g.realpath(__dirname+"/../../",function(k,h){k&&(d.error("No way to get root path",k),process.exit(1));e.root=h;"function"===typeof c&&c(e)})});return e};a.conf=
function(c){return e.loaded?e:a.read(c)}})(exports);(function(){require("./conf.js").conf(function(a){require("./server.js").run(a)})})();(function(a){var b=require("connect"),f=require("serve-static"),g=require("body-parser"),d=require("./lib/blog.js"),e=require("./lib/init.js").initialize,c=require("./routes/router.js").router,k=require("./lib/job.js"),h=require("./controllers/404.js");a.run=function(a){var l=b();l.conf=a;l.logger=a.logger;k.init();d.init(function(){l.use(require("./lib/auth.js").auth);l.use(f(a.WEB_SERVER_STATIC_PATH||__dirname+"/../../dist"));l.use(g({limit:"10mb"}));l.use(e);l.use(c());l.use(h.index);l.listen(a.WEB_SERVER_PORT);
l.logger.log("Server started on "+a.WEB_SERVER_HOST+":"+a.WEB_SERVER_PORT)})}})(exports);(function(a){var b=require("../lib/controller-view.js");a.index=function(a,g,d){a.logger.warn("Page not found: ["+a.method+"] "+a.url);b.view(a,g,"404.html")}})(exports);(function(){var a=require("../lib/controller-view.js"),b=/<p>([^<]+)/im,f={},g={};exports.add=function(a,e){f[a]=e;var c=b.exec(e);g[a]=c?c[1].split("\n").join(" "):""};exports.index=function(b,e,c){c=[];var k,h;for(k in f)f.hasOwnProperty(k)&&(h=k.split("/blog/").join("").split(".html").join("").split("-"),c.push({url:"/blog/"+h.join("-")+".html",date:h.splice(0,3).join("/"),title:h.join(" ")}));a.view(b,e,"blog/articles.html",{articles:c})};exports.article=function(b,e,c){c=b.url.split("/blog/").join("").split(".html").join("").split("-");
a.view(b,e,"blog/article.html",{summary:g[b.url],url:"http://www.minethat.co"+b.url,content:f[b.url]||"Article not found",date:c.splice(0,3).join("/"),title:c.join(" ")})}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,f,g){a.findAll(b,f,"Document",null,null,null,"document/list.html")};exports.display=function(b,f,g){a.find(b,f,"Document","document/display.html")};exports.remove=function(b,f,g){a.remove(b,f,"Document")}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/valid.js"),f=require("../lib/mail.js"),g=require("url"),d=require("ua-parser-js"),e=require("../routes/campaigns.js").campaigns;exports.campaign=function(c){var k={ref_campaign:"None",ref_domain:"Unknown"};c.query&&c.query.r&&(k.ref_campaign=e[c.query.r]||c.query.r);c.headers.referer&&(k.ref_domain=g.parse(c.headers.referer).hostname,0===k.ref_domain.indexOf("www.")&&(k.ref_domain=k.ref_domain.substr(4)));return k};exports.index=
function(c,k,b){a.view(c,k,"landing/landing.html",exports.campaign(c))};exports.subscribe=function(c,k,a){a=c.model("Subscriber");if(!c.body||!c.body.email)return k.json({error:"miss_param"},500);if(!b.email(c.body.email))return k.json({error:"invalid_email"},500);a.findOne({email:c.body.email},function(a,b){if(a)return k.json({error:"db_check_failed"},500);if(b)return k.json({status:"exists",id:b._id},200);exports.create(c,k)})};exports.create=function(c,a){var b=c.model("Subscriber"),e=(new d).setUA(c.headers["user-agent"]).getResult()||
{},g=new b({email:c.body.email,ref_campaign:c.body.ref_campaign,ref_domain:c.body.ref_domain,browser:e.browser&&e.browser.name?e.browser.name:"Unknown",os:e.os&&e.os.name?e.os.name:"Unknown",device:e.device&&e.device.vendor?e.device.vendor+" / "+(e.device.model||"Unknown"):"Unknown"});g.save(function(b){if(b)return a.json({error:"db_save_failed"},500);f.template(c.body.email,"You're in!","landing-subscribed.html",{sub:g});f.template("xav@minethat.co","He's in!","landing-subscribed-alert.html",{sub:g});
a.json({status:"success"})})}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/internet.js");exports.index=function(b,g,d){a.findAll(b,g,"Source",null,null,null,"source/list.html")};exports.display=function(b,g,d){a.find(b,g,"Source","source/edit.html")};exports.from_feed=function(f,g,d){"GET"===f.method?a.view(f,g,"source/from_feed.html"):b.feed(f.body.feed_url,function(b,c){b||!c?a.view(f,g,"source/from_feed.html",{error:"Invalid feed"}):(f.body.name=c.metadata.title,f.body.url=c.metadata.url,exports.add(f,
g,d))})};exports.add=function(b,g,d){a.create(b,g,"Source","source/edit.html","/app/source/:id")};exports.edit=function(b,g,d){a.edit(b,g,"Source","source/edit.html")};exports.check=function(a,g,d){b.feed(a.body.feed_url,function(b,c){b||!c?g.json({status:"error",error:"Invalid feed"},422):a.findAll(a,"Source",{feed_url:a.body.feed_url},null,null,function(c,b){c?g.json({status:"error",error:"Internal error"},500):(console.log(b),0===b.total?g.json({status:"success"},200):g.json({status:"exists"},
409))})})};exports.remove=function(b,g,d){a.remove(b,g,"Source")}})();(function(){var a=require("../lib/job.js");exports.html_string=function(b,a,g){if(!b.body.content)return a.json({status:"error",error:'Missing "content" parameter'},500);exports.submit(b,a,"HTML_STRING",b.body.content)};exports.string=function(b,a,g){if(!b.body||!b.body.string)return a.json({status:"error",error:'Missing "string" parameter'},500);exports.submit(b,a,"STRING",b.body.string)};exports.url=function(b,a,g){if(!b.body||!b.body.url)return a.json({status:"error",error:'Missing "url" parameter'},
500);exports.submit(b,a,"URL",b.body.url)};exports.submit=function(b,f,g,d){console.log("[API] Got request");var e={customerId:"2c7f9a",gateway:"API",status:"VOID",type:g,value:d};b.body.meta&&(e.meta=b.body.meta);if(b.body.target&&"TRAIN"===b.body.target){if(!b.body||!b.body.classes)return f.json({status:"error",error:'Missing "classes" parameter'},500);e.target="TRAIN";e.classes=b.body.classes}a.makeup(e,function(c){return c?f.json({status:"error",error:"DB error"},500):f.json({status:"success",
job:e._id})})}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,f,g){a.findAll(b,f,"Subscriber",null,null,null,"subscriber/list.html")};exports.display=function(b,f,g){a.find(b,f,"Subscriber","subscriber/display.html")};exports.csv=function(b,f,g){a.find(b,f,"Subscriber","subscriber/display.html")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,f){var g=b.model("Subscriber");if(!b.query.id)return f.error("Missing param for unsubscription",500);g.findById(b.query.id,function(d,e){var c=null;if(d)return f.error("DB query error",500);b.query.action&&("unsubscribe"===b.query.action?(e.unactivated=!0,c="Done! You won't receive our newsletter anymore."):(e.unactivated=!1,c="Thanks! You're now subscribed to our newsletter!"),e.save());a.view(b,f,"subscriber/subscription.html",
{msg:c,sub:e})})}})();(function(){var a=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(b,f,g){0===b._parsedUrl.href.indexOf("/private")||0===b._parsedUrl.href.indexOf("/admin")||0===b._parsedUrl.href.indexOf("/app")?a.check(b,f,function(a){g()}):g()}})();(function(){var a=require("fs"),b=require("../routes/routes.js"),f=require("../controllers/blog.js"),g=require("marked"),d=require("../conf.js").conf();exports.add=function(e){var c=e.split(".md").join("");b.add("/blog/"+c+".html",["get","blog.article"]);a.readFile(d.root+"/src/blog/"+e,function(a,b){a?d.logger.error("Unable to read blog article"+d.root+"/src/blog/"+e,a):g(b.toString(),{},function(a,b){a?d.logger.error("Unable to convert blog article"+d.root+"/src/blog/"+e,a):f.add("/blog/"+c+".html",
b)})})};exports.init=function(b){a.readdir(d.root+"/src/blog/",function(c,a){if(c)d.logger.error('Blog files not found at "'+d.root+'/src/blog/"',c);else{var h,g=a.length;for(h=0;h<g;h+=1)-1<a[h].indexOf(".md")&&exports.add(a[h]);"function"===typeof b&&b()}})}})();(function(){var a=require("ejs"),b=require("fs"),f=require("async"),g=require("../conf.js").conf(),d=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,e={};exports.remove=function(c,a,b,e){c.isAPI?c.model(b).findById(c.params.id,function(c,b){c||null===b?a.json({status:"error",error:"Resource not found"},404):b.remove(function(c){c?a.json({status:"error",error:"Resource not deleted"},500):a.json({status:"success"},200)})}):a.error(404,"Only available through API")};exports.save=function(c,a,b,
e,d){var g=new (c.model(b))(c.body),f=!1;g.save(function(b){var h={status:b?"success":"error",doc:g.toObject()};f||(f=!0,b&&(h.error={message:b}),c.isAPI?a.json(h,b?500:200):d?a.redirect(d.split(":id").join(g._id)):exports.view(c,a,e,h))})};exports.create=function(c,a,b,e,d){var g=c.model(b);"POST"===c.method?exports.save(c,a,b,e,d):c.isAPI?a.json({error:"Not implemented"},500):exports.view(c,a,e,{doc:new g,status:"create"})};exports.find=function(c,a,b,e){c.find(b,c.params.id,function(b,d){if(b)return a.error(500);
d?(console.log(d.toObject()),c.isAPI?a.json(d.toObject()):exports.view(c,a,e,{doc:d,status:"exists"})):c.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})};exports.edit=function(c,a,b,e){"GET"===c.method?exports.find(c,a,b,e):c.model(b).update({_id:c.params.id},c.body,function(d,g,f){if(d)return a.error(500);c.find(b,c.params.id,function(b,d){if(b)return a.error(500);d?c.isAPI?a.json(d):exports.view(c,a,e,{doc:d,status:"exists"}):c.isAPI?a.json({status:"error",error:"Resource not found"},
404):a.error(404)})})};exports.findAll=function(c,a,b,e,d,g,f){c.findAll(c,b,e,d,g,function(b,e){if(b)return a.error(404);c.isAPI?a.json(e):exports.view(c,a,f,e)})};exports.requiresLoading=function(c){return!e[c]||"local"===g.env};exports.load=function(c,a){b.readFile(__dirname+"/../views/"+c,function(b,d){b?(g.logger.error("File not found: views/"+c),e[c]="Template not found"):e[c]=d.toString();var f=exports.detectPartials(c);0<f.length?exports.loadPartials(f,a):"function"===typeof a&&a()})};exports.render=
function(c,b){try{return a.render(e[c],{data:b?b:{},partial:exports.partial,env:g.env})}catch(d){return g.logger.error("Unable to render template",d),null}};exports.view=function(c,a,b,e){exports.renderView(b,e,function(c){a.html(c)})};exports.renderView=function(c,a,b){var e=function(){b(exports.render(c,a))};if(exports.requiresLoading(c))return exports.load(c,e);e()};exports.partial=function(c,b){var d={data:b};d.env=g.env;d.partial=exports.partial;return a.render(e["_partials/"+c+".html"],d)};
exports.loadPartials=function(c,a){var b,e=c.length,d=[];for(b=0;b<e;b+=1)d.push(exports.loadPartial(c[b]));f.parallel(d,a)};exports.loadPartial=function(c){return function(a){exports.load("_partials/"+c+".html",a)}};exports.detectPartials=function(c){for(var a=[],b;;){b=d.exec(e[c]);if(!b)break;a.push(b[1])}return a}})();(function(a){var b=require("../conf.js").conf(),f=require("./respond.js"),g=require("./models.js"),d=require("qs");a.initialize=function(a,c,k){var h;a.logger=b.logger;a.query=d.parse(a._parsedUrl.query);for(h in g)g.hasOwnProperty(h)&&(a[h]?b.logger.error("Injection failed: key "+h+"already defined in Request object"):a[h]=g[h]);for(h in f)f.hasOwnProperty(h)&&(c[h]?b.logger.error("Injection failed: key "+h+"already defined in Response object"):c[h]=f[h]);k()}})(exports);(function(a){var b=require("request"),f=require("blindparser");a.get=function(a,d){b(a,function(a,c){a||200!==c.statusCode?d(a):d(null,c.body,c.href)})};a.feed=function(b,d){a.get(b,function(a,c,b){if(a)d(a);else try{f.parseString(c,{},function(a,c){a?d(a):d(null,c,b)})}catch(g){d(g)}})}})(exports);(function(){var a=require("amqp"),b=require("../conf.js").conf(),f=!1,g=require("./models.js"),d;exports.init=function(e){d=a.createConnection({host:b.RABBIT_HOST,port:b.RABBIT_PORT});d.on("ready",function(){console.log("[RabbitMQ] Connection established");d.queue(b.RABBIT_EXTRACT_QUEUE,{durable:!0,exclusive:!1,autoDelete:!1},function(a){console.log("[RabbitMQ] Queue declared");f=!0;"function"===typeof e&&e()})});d.on("error",function(){f=!1;console.log("[RabbitMQ] Error",arguments)})};exports.makeup=
function(a,c){var b=new (g.model("Job"))(a);b.save(function(a){a||exports.publish(b._id);"function"===typeof c&&c(a,b)})};exports.publish=function(a){f?(console.log("[RabbitMQ] Submitted job "+a),d.publish("extract",a)):setTimeout(function(){exports.publish(a)},100)}})();(function(){var a,b=require("html-to-text"),f=require("./controller-view.js"),g=require("../conf.js").conf(),d=g.logger,e=require("nodemailer");exports.html=function(c,f,h,m,l){a||(a=e.createTransport("SMTP",{service:"Gmail",auth:{user:g.WEB_EMAIL_USER,pass:g.WEB_EMAIL_PASS}}));a.sendMail({from:m||"Xav from Minethat <xav@minethat.co>",to:c,subject:f,text:l||b.fromString(h),html:h},function(a,c){a?d.error(a):d.debug("Message sent: "+c.message)})};exports.template=function(a,b,d,e,g,n){f.renderView("emails/"+
d,e,function(d){exports.html(a,b,d,g,n)})}})();(function(){var a={},b=require("../conf.js").conf(),f=b.logger,g=require("mongoose"),b="mongodb://"+b.MONGO_HOST+":"+b.MONGO_PORT+"/"+b.MONGO_DB_PREFIX+b.env.toLowerCase();g.connect(b);f.info("Connecting to mongo on "+b);exports.loadModel=function(b){a[b]=require("../models/"+b.toLowerCase()+".js").define(g)};exports.model=function(b){a[b]||exports.loadModel(b);return a[b]};exports.find=function(a,b,c){"string"===typeof a&&(a=exports.model(a));a.findById(b,function(a,b){a&&f.error("Error querying db",
a);"function"===typeof c&&c(a,b)})};exports.findAll=function(a,b,c,g,h,m){var l=a.query?parseInt(a.query.page,10)||1:1;"string"===typeof b&&(b=exports.model(b));b.count(c||{},function(a,d){a&&f.error("Error querying db",a);b.find(c||{},g||{},exports.page(l,h),function(a,b){a&&f.error("Error querying db",a);"function"===typeof m&&m(a,{docs:b,total:d,limit:20,page:l,hasNext:20*l<d,hasPrevious:1<l})})})};exports.page=function(a,b){var c,g;c={skip:20*(a-1),limit:20};if(b)for(g in b)b.hasOwnProperty(g)&&
(c[g]=b[g]);return c}})();(function(){exports.error=function(a){this.respond(a||404,"text/plain","File not found")};exports.html=function(a,b){this.respond(b||200,"text/html",a)};exports.plain=function(a,b){this.respond(b||200,"text/plain",a)};exports.json=function(a,b){this.respond(b||200,"application/json","string"===typeof a?a:JSON.stringify(a))};exports.respond=function(a,b,f){this.writeHead(a,{"Content-type":b});this.end(f)};exports.redirect=function(a){this.writeHead(302,{Location:a});this.end()}})();(function(){exports.email=function(a){var b,f;if(!a||"string"!==typeof a)return!1;b=a.indexOf("@");f=a.lastIndexOf(".");return 0<b&&3<f&&b<f&&a.length>f+2}})();(function(){exports.define=function(a){return a.model("Document",new a.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(a){return a.model("Job",new a.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{url:String,title:String,author:String,organization:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){var a=require("../lib/internet.js");exports.define=function(b){var f=new b.Schema({name:String,url:String,feed_url:{type:String,index:!0},type:{type:String,"default":"CONTENT"},customer_id:{type:String,index:!0},last:{type:Number},fake:{type:Boolean,"default":!1}});b=b.model("Source",f);f.pre("save",function(b){var d=this,e=!1,c=0,f=function(a){a&&(e=!0);c+=1;2===c&&b(e?Error("Validation error"):null)};a.get(this.url,function(a,b,c){a&&d.invalidate("url","URL is invalid");f(a)});a.feed(this.feed_url,
function(a,b,c){a&&d.invalidate("url","Feed URL is invalid");f(a)})});return b}})();(function(){exports.define=function(a){return a.model("Subscriber",new a.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.campaigns={b:"Blog",r1:"Reddit landing feedback",r2:"Reddit marketing campaign",t1:"Twitter Minethat link",t2:"Twitter xav link",c1:"First marketing campaign",e1:"Xav email footer",e2:"Minethat email footer",e3:"Newsletters"}})();(function(){var a=require("./routes.js").routes,b={},f=require("urlrouter");exports.setup=function(a,b,e,c,f){if("function"!==typeof c[f])throw Error('Route "'+e+'" is invalid:  function "'+f+'" does not exist in controller.');a[b](e,function(a,b,d){0===e.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;c[f](a,b,d)})};exports.route=function(a,d,e){var c=e[1].split(".");b[c[0]]||(b[c[0]]=require("../controllers/"+c[0]+".js"));2>c.length&&(c[1]="index");exports.setup(a,e[0],d,b[c[0]],c[1])};exports.apply=function(b){var d,
e,c;for(d in a)if(a.hasOwnProperty(d))if("string"===typeof a[d][0])exports.route(b,d,a[d]);else for(e=0,c=a[d].length;e<c;e+=1)exports.route(b,d,a[d][e])};exports.router=function(){return f(exports.apply)}})();(function(){exports.add=function(a,b){exports.routes[a]=b};exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/document/:id":["get","document.display"],"/admin/subscribers":["get","subscriber"],"/admin/subscribers.csv":["get","subscriber.csv"],
"/admin/subscriber/:id":["get","subscriber.display"],"/api/v1/sources":["get","source.index"],"/api/v1/sources/check":["post","source.check"],"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],"/api/v1/source":["post","source.add"],"/api/v1/document/:id":[["get","document.display"],["delete","document.remove"]],"/api/v1/submit/url":["post","submit.url"],"/api/v1/submit/string":["post","submit.string"],"/api/v1/submit/html_string":["post","submit.html_string"],
"/":["get","home"],"/blog":["get","blog"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();
