(function(){var b,c,d,f=require("./lib/internet.js"),a=0;exports.aggregate=function(a,e){f.feed(a.feed_url,function(h,k){var b=k.items,d,c=0,f=b.length;for(d=0;d<f;d+=1)b[d].date>(a.last||0)&&(console.log(b[d].title),b[d].date>c&&(c=b[d].date));0<c&&(a.last=c);e(a)})};exports.check=function(a){exports.aggregate(a,function(e){d.update({_id:e._id},{last:e.last},function(e,a,g){e?b.error("Error updating source",e):0===a&&b.error("Error updating source: no item affected")})})};exports.update=function(){d.find({},
{},{skip:a,limit:1},function(g,e){if(g)b.error("Error querying db",g);else{var h,k=e.length;if(0===k)a=0;else for(a+=1,h=0;h<k;h+=1)exports.check(e[h])}})};require("./conf.js").conf(function(a){b=a.logger;c=require("./lib/models.js");d=c.model("Source");setInterval(function(){exports.update()},3E4);exports.update()})})();(function(){var b=process.env.ENV,c,d=require("fs"),f=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(a){5===a.level?console.error(a.output):console.log(a.output)}}),a={loaded:!1,logger:f,env:b};"string"!==typeof b&&(f.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));c=__dirname+"/../../../conf/conf."+b+".sh";exports.parseLine=
function(g){0!==g.indexOf("#")&&0<g.indexOf("=")&&(g=g.split("="),a[g[0]]=/^[0-9]+$/ig.test(g[1])?parseInt(g[1],10):g[1])};exports.parse=function(a){a=a.split("\n");var e,h=a.length;for(e=0;e<h;e+=1)exports.parseLine(a[e])};exports.read=function(b){a.loaded=!0;d.readFile(c,function(e,h){e&&(f.error("No way to load conf",e),process.exit(1));exports.parse(h.toString());d.realpath(__dirname+"/../../",function(e,h){e&&(f.error("No way to get root path",e),process.exit(1));a.root=h;"function"===typeof b&&
b(a)})});return a};exports.conf=function(b){return a.loaded?a:exports.read(b)}})();(function(){require("./conf.js").conf(function(b){require("./server.js").run(b)})})();(function(){var b=require("connect"),c=require("serve-static"),d=require("body-parser"),f=require("./lib/blog.js"),a=require("./lib/init.js").initialize,g=require("./routes/router.js").router,e=require("./controllers/404.js"),h;exports.run=function(k){h=b();h.conf=k;h.logger=k.logger;f.init(function(){h.use(require("./lib/auth.js").auth);h.use(c(k.WEB_SERVER_STATIC_PATH||__dirname+"/../../dist"));h.use(d({limit:"2mb"}));h.use(a);h.use(g());h.use(e.index);h.listen(k.WEB_SERVER_PORT);h.logger.log("Server started on "+
k.WEB_SERVER_HOST+":"+k.WEB_SERVER_PORT)})}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(c,d,f){c.logger.warn("Page not found: ["+c.method+"] "+c.url);b.view(c,d,"404.html")}})();(function(){var b=require("../lib/controller-view.js"),c=/<p>([^<]+)/im,d={},f={};exports.add=function(a,b){d[a]=b;var e=c.exec(b);f[a]=e?e[1].split("\n").join(" "):""};exports.index=function(a,g,e){e=[];var h,k;for(h in d)d.hasOwnProperty(h)&&(k=h.split("/blog/").join("").split(".html").join("").split("-"),e.push({url:"/blog/"+k.join("-")+".html",date:k.splice(0,3).join("/"),title:k.join(" ")}));b.view(a,g,"blog/articles.html",{articles:e})};exports.article=function(a,g,e){e=a.url.split("/blog/").join("").split(".html").join("").split("-");
b.view(a,g,"blog/article.html",{summary:f[a.url],url:"http://www.minethat.co"+a.url,content:d[a.url]||"Article not found",date:e.splice(0,3).join("/"),title:e.join(" ")})}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(c,d,f){b.findAll(c,d,"Document",null,null,null,"document/list.html")};exports.display=function(c,d,f){b.find(c,d,"Document","document/display.html")};exports.remove=function(c,d,f){b.remove(c,d,"Document")}})();(function(){var b=require("../lib/controller-view.js"),c=require("../lib/valid.js"),d=require("../lib/mail.js"),f=require("url"),a=require("ua-parser-js"),g=require("../routes/campaigns.js").campaigns;exports.campaign=function(e){var a={ref_campaign:"None",ref_domain:"Unknown"};e.query&&e.query.r&&(a.ref_campaign=g[e.query.r]||e.query.r);e.headers.referer&&(a.ref_domain=f.parse(e.headers.referer).hostname,0===a.ref_domain.indexOf("www.")&&(a.ref_domain=a.ref_domain.substr(4)));return a};exports.index=
function(e,a,d){b.view(e,a,"landing/landing.html",exports.campaign(e))};exports.subscribe=function(e,a,b){b=e.model("Subscriber");if(!e.body||!e.body.email)return a.json({error:"miss_param"},500);if(!c.email(e.body.email))return a.json({error:"invalid_email"},500);b.findOne({email:e.body.email},function(b,d){if(b)return a.json({error:"db_check_failed"},500);if(d)return a.json({status:"exists",id:d._id},200);exports.create(e,a)})};exports.create=function(e,h){var b=e.model("Subscriber"),g=(new a).setUA(e.headers["user-agent"]).getResult()||
{},c=new b({email:e.body.email,ref_campaign:e.body.ref_campaign,ref_domain:e.body.ref_domain,browser:g.browser&&g.browser.name?g.browser.name:"Unknown",os:g.os&&g.os.name?g.os.name:"Unknown",device:g.device&&g.device.vendor?g.device.vendor+" / "+(g.device.model||"Unknown"):"Unknown"});c.save(function(a){if(a)return h.json({error:"db_save_failed"},500);d.template(e.body.email,"You're in!","landing-subscribed.html",{sub:c});d.template("xav@minethat.co","He's in!","landing-subscribed-alert.html",{sub:c});
h.json({status:"success"})})}})();(function(){var b=require("../lib/controller-view.js"),c=require("../lib/internet.js");exports.index=function(d,c,a){b.findAll(d,c,"Source",null,null,null,"source/list.html")};exports.display=function(d,c,a){b.find(d,c,"Source","source/edit.html")};exports.from_feed=function(d,f,a){"GET"===d.method?b.view(d,f,"source/from_feed.html"):c.feed(d.body.feed_url,function(g,e){g||!e?b.view(d,f,"source/from_feed.html",{error:"Invalid feed"}):(d.body.name=e.metadata.title,d.body.url=e.metadata.url,exports.add(d,
f,a))})};exports.add=function(d,c,a){b.create(d,c,"Source","source/edit.html","/app/source/:id")};exports.edit=function(d,c,a){b.edit(d,c,"Source","source/edit.html")};exports.check=function(b,f,a){c.feed(b.body.feed_url,function(a,e){a||!e?f.json({status:"error",error:"Invalid feed"},422):b.findAll(b,"Source",{feed_url:b.body.feed_url},null,null,function(e,a){e?f.json({status:"error",error:"Internal error"},500):(console.log(a),0===a.total?f.json({status:"success"},200):f.json({status:"exists"},
409))})})};exports.remove=function(c,f,a){b.remove(c,f,"Source")}})();(function(){var b=require("amqp"),c=require("../conf.js").conf(),d=!1,f;exports.init=function(a){f=b.createConnection({host:c.RABBIT_HOST,port:c.RABBIT_PORT});f.on("ready",function(){console.log("[RabbitMQ] Connection established");f.queue(c.RABBIT_EXTRACT_QUEUE,{durable:!0,exclusive:!1,autoDelete:!1},function(b){console.log("[RabbitMQ] Queue declared");d=!0;"function"===typeof a&&a()})});f.on("error",function(){d=!1;console.log("[RabbitMQ] Error",arguments)})};exports.publish=function(a){d?(console.log("[RabbitMQ] Submitted job "+
a),f.publish("extract",a)):setTimeout(function(){exports.publish(a)},100)};exports.html_string=function(a,b,e){if(!a.body.content)return b.json({status:"error",error:'Missing "content" parameter'},500);exports.submit(a,b,"HTML_STRING",a.body.content)};exports.string=function(a,b,e){if(!a.body||!a.body.string)return b.json({status:"error",error:'Missing "string" parameter'},500);exports.submit(a,b,"STRING",a.body.string)};exports.url=function(a,b,e){if(!a.body||!a.body.url)return b.json({status:"error",
error:'Missing "url" parameter'},500);exports.submit(a,b,"URL",a.body.url)};exports.submit=function(a,b,e,h){console.log("[API] Got request");var c=new (a.model("Job"))({customerId:"2c7f9a",gateway:"API",status:"VOID",type:e,value:h});a.body.meta&&(c.meta=a.body.meta);if(a.body.target&&"TRAIN"===a.body.target){if(!a.body||!a.body.classes)return b.json({status:"error",error:'Missing "classes" parameter'},500);c.target="TRAIN";c.classes=a.body.classes}c.save(function(e){return e?b.json({status:"error",
error:"DB error"},500):(exports.publish(c._id),b.json({status:"success",job:c._id}))})};exports.init()})();(function(){var b=require("../lib/controller-view.js");exports.index=function(c,d,f){b.findAll(c,d,"Subscriber",null,null,null,"subscriber/list.html")};exports.display=function(c,d,f){b.find(c,d,"Subscriber","subscriber/display.html")};exports.csv=function(c,d,f){b.find(c,d,"Subscriber","subscriber/display.html")}})();(function(){var b=require("../lib/controller-view.js");exports.index=function(c,d){var f=c.model("Subscriber");if(!c.query.id)return d.error("Missing param for unsubscription",500);f.findById(c.query.id,function(a,g){var e=null;if(a)return d.error("DB query error",500);c.query.action&&("unsubscribe"===c.query.action?(g.unactivated=!0,e="Done! You won't receive our newsletter anymore."):(g.unactivated=!1,e="Thanks! You're now subscribed to our newsletter!"),g.save());b.view(c,d,"subscriber/subscription.html",
{msg:e,sub:g})})}})();(function(){var b=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(c,d,f){0===c._parsedUrl.href.indexOf("/private")||0===c._parsedUrl.href.indexOf("/admin")||0===c._parsedUrl.href.indexOf("/app")?b.check(c,d,function(a){f()}):f()}})();(function(){var b=require("fs"),c=require("../routes/routes.js"),d=require("../controllers/blog.js"),f=require("marked"),a=require("../conf.js").conf();exports.add=function(g){var e=g.split(".md").join("");c.add("/blog/"+e+".html",["get","blog.article"]);b.readFile(a.root+"/src/blog/"+g,function(b,c){b?a.logger.error("Unable to read blog article"+a.root+"/src/blog/"+g,b):f(c.toString(),{},function(b,h){b?a.logger.error("Unable to convert blog article"+a.root+"/src/blog/"+g,b):d.add("/blog/"+e+".html",
h)})})};exports.init=function(c){b.readdir(a.root+"/src/blog/",function(e,b){if(e)a.logger.error('Blog files not found at "'+a.root+'/src/blog/"',e);else{var d,f=b.length;for(d=0;d<f;d+=1)-1<b[d].indexOf(".md")&&exports.add(b[d]);"function"===typeof c&&c()}})}})();(function(){var b=require("ejs"),c=require("fs"),d=require("async"),f=require("../conf.js").conf(),a=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,g={};exports.remove=function(e,a,b,c){e.isAPI?e.model(b).findById(e.params.id,function(e,b){e||null===b?a.json({status:"error",error:"Resource not found"},404):b.remove(function(e){e?a.json({status:"error",error:"Resource not deleted"},500):a.json({status:"success"},200)})}):a.error(404,"Only available through API")};exports.save=function(e,a,b,
c,d){var g=new (e.model(b))(e.body),f=!1;g.save(function(b){var k={status:b?"success":"error",doc:g.toObject()};f||(f=!0,b&&(k.error={message:b}),e.isAPI?a.json(k,b?500:200):d?a.redirect(d.split(":id").join(g._id)):exports.view(e,a,c,k))})};exports.create=function(e,a,b,c,d){var g=e.model(b);"POST"===e.method?exports.save(e,a,b,c,d):e.isAPI?a.json({error:"Not implemented"},500):exports.view(e,a,c,{doc:new g,status:"create"})};exports.find=function(e,a,b,c){e.find(b,e.params.id,function(b,d){if(b)return a.error(500);
d?(console.log(d.toObject()),e.isAPI?a.json(d()):exports.view(e,a,c,{doc:d.toObject(),status:"exists"})):e.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})};exports.edit=function(a,b,c,d){"GET"===a.method?exports.find(a,b,c,d):a.model(c).update({_id:a.params.id},a.body,function(g,f,m){if(g)return b.error(500);a.find(c,a.params.id,function(c,g){if(c)return b.error(500);g?a.isAPI?b.json(g):exports.view(a,b,d,{doc:g,status:"exists"}):a.isAPI?b.json({status:"error",error:"Resource not found"},
404):b.error(404)})})};exports.findAll=function(a,b,c,d,g,f,m){a.findAll(a,c,d,g,f,function(c,d){if(c)return b.error(404);a.isAPI?b.json(d):exports.view(a,b,m,d)})};exports.requiresLoading=function(a){return!g[a]||"local"===f.env};exports.load=function(a,b){c.readFile(__dirname+"/../views/"+a,function(c,d){c?(f.logger.error("File not found: views/"+a),g[a]="Template not found"):g[a]=d.toString();var l=exports.detectPartials(a);0<l.length?exports.loadPartials(l,b):"function"===typeof b&&b()})};exports.render=
function(a,c){try{return b.render(g[a],{data:c?c:{},partial:exports.partial,env:f.env})}catch(d){return f.logger.error("Unable to render template",d),null}};exports.view=function(a,b,c,d){exports.renderView(c,d,function(a){b.html(a)})};exports.renderView=function(a,b,c){var d=function(){c(exports.render(a,b))};if(exports.requiresLoading(a))return exports.load(a,d);d()};exports.partial=function(a,c){var d={data:c};d.env=f.env;d.partial=exports.partial;return b.render(g["_partials/"+a+".html"],d)};
exports.loadPartials=function(a,b){var c,g=a.length,f=[];for(c=0;c<g;c+=1)f.push(exports.loadPartial(a[c]));d.parallel(f,b)};exports.loadPartial=function(a){return function(b){exports.load("_partials/"+a+".html",b)}};exports.detectPartials=function(b){for(var c=[],d;;){d=a.exec(g[b]);if(!d)break;c.push(d[1])}return c}})();(function(){var b=require("../conf.js").conf(),c=require("./respond.js"),d=require("./models.js"),f=require("qs");exports.initialize=function(a,g,e){var h;a.logger=b.logger;a.query=f.parse(a._parsedUrl.query);for(h in d)d.hasOwnProperty(h)&&(a[h]?b.logger.error("Injection failed: key "+h+"already defined in Request object"):a[h]=d[h]);for(h in c)c.hasOwnProperty(h)&&(g[h]?b.logger.error("Injection failed: key "+h+"already defined in Response object"):g[h]=c[h]);e()}})();(function(){var b=require("request"),c=require("blindparser");exports.get=function(c,f){b(c,function(a,b){a||200!==b.statusCode?f(a):f(null,b.body,b.href)})};exports.feed=function(b,f){exports.get(b,function(a,b,e){if(a)f(a);else try{c.parseString(b,{},function(a,b){a?f(a):f(null,b)})}catch(d){f(d)}})}})();(function(){var b,c=require("html-to-text"),d=require("./controller-view.js"),f=require("../conf.js").conf(),a=f.logger,g=require("nodemailer");exports.html=function(e,d,k,n,l){b||(b=g.createTransport("SMTP",{service:"Gmail",auth:{user:f.WEB_EMAIL_USER,pass:f.WEB_EMAIL_PASS}}));b.sendMail({from:n||"Xav from Minethat <xav@minethat.co>",to:e,subject:d,text:l||c.fromString(k),html:k},function(b,c){b?a.error(b):a.debug("Message sent: "+c.message)})};exports.template=function(a,b,c,g,f,p){d.renderView("emails/"+
c,g,function(c){exports.html(a,b,c,f,p)})}})();(function(){var b={},c=require("../conf.js").conf(),d=c.logger,f=require("mongoose");f.connect("mongodb://"+c.MONGO_HOST+":"+c.MONGO_PORT+"/"+c.MONGO_DB_PREFIX+c.env.toLowerCase());exports.loadModel=function(a){b[a]=require("../models/"+a.toLowerCase()+".js").define(f)};exports.model=function(a){b[a]||exports.loadModel(a);return b[a]};exports.find=function(a,b,c){"string"===typeof a&&(a=exports.model(a));a.findById(b,function(a,b){a&&d.error("Error querying db",a);"function"===typeof c&&c(a,b)})};
exports.findAll=function(a,b,c,f,k,n){var l=a.query?parseInt(a.query.page,10)||1:1;"string"===typeof b&&(b=exports.model(b));b.count(c||{},function(a,m){a&&d.error("Error querying db",a);b.find(c||{},f||{},exports.page(l,k),function(a,b){a&&d.error("Error querying db",a);"function"===typeof n&&n(a,{docs:b,total:m,limit:20,page:l,hasNext:20*l<m,hasPrevious:1<l})})})};exports.page=function(a,b){var c,d;c={skip:20*(a-1),limit:20};if(b)for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c}})();(function(){exports.error=function(b){this.respond(b||404,"text/plain","File not found")};exports.html=function(b,c){this.respond(c||200,"text/html",b)};exports.plain=function(b,c){this.respond(c||200,"text/plain",b)};exports.json=function(b,c){this.respond(c||200,"application/json","string"===typeof b?b:JSON.stringify(b))};exports.respond=function(b,c,d){this.writeHead(b,{"Content-type":c});this.end(d)};exports.redirect=function(b){this.writeHead(302,{Location:b});this.end()}})();(function(){exports.email=function(b){var c,d;if(!b||"string"!==typeof b)return!1;c=b.indexOf("@");d=b.lastIndexOf(".");return 0<c&&3<d&&c<d&&b.length>d+2}})();(function(){exports.define=function(b){return b.model("Document",new b.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(b){return b.model("Job",new b.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{url:String,title:String,author:String,organization:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){var b=require("../lib/internet.js");exports.define=function(c){var d=new c.Schema({name:String,url:String,feed_url:{type:String,index:!0},type:{type:String,"default":"CONTENT"},customer_id:{type:String,index:!0},last:{type:Number},fake:{type:Boolean,"default":!1}});c=c.model("Source",d);d.pre("save",function(c){var a=this,d=!1,e=0,h=function(a){a&&(d=!0);e+=1;2===e&&c(d?Error("Validation error"):null)};b.get(this.url,function(b,c,d){b&&a.invalidate("url","URL is invalid");h(b)});b.feed(this.feed_url,
function(b,c,d){b&&a.invalidate("url","Feed URL is invalid");h(b)})});return c}})();(function(){exports.define=function(b){return b.model("Subscriber",new b.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.campaigns={b:"Blog",r1:"Reddit landing feedback",r2:"Reddit marketing campaign",t1:"Twitter Minethat link",t2:"Twitter xav link",c1:"First marketing campaign",e1:"Xav email footer",e2:"Minethat email footer",e3:"Newsletters"}})();(function(){var b=require("./routes.js").routes,c={},d=require("urlrouter");exports.setup=function(b,a,c,d,h){if("function"!==typeof d[h])throw Error('Route "'+c+'" is invalid:  function "'+h+'" does not exist in controller.');b[a](c,function(a,b,f){0===c.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;d[h](a,b,f)})};exports.route=function(b,a,d){var e=d[1].split(".");c[e[0]]||(c[e[0]]=require("../controllers/"+e[0]+".js"));2>e.length&&(e[1]="index");exports.setup(b,d[0],a,c[e[0]],e[1])};exports.apply=function(c){var a,
d,e;for(a in b)if(b.hasOwnProperty(a))if("string"===typeof b[a][0])exports.route(c,a,b[a]);else for(d=0,e=b[a].length;d<e;d+=1)exports.route(c,a,b[a][d])};exports.router=function(){return d(exports.apply)}})();(function(){exports.add=function(b,c){exports.routes[b]=c};exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/document/:id":["get","document.display"],"/admin/subscribers":["get","subscriber"],"/admin/subscribers.csv":["get","subscriber.csv"],
"/admin/subscriber/:id":["get","subscriber.display"],"/api/v1/sources":["get","source.index"],"/api/v1/sources/check":["post","source.check"],"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],"/api/v1/source":["post","source.add"],"/api/v1/document/:id":[["get","document.display"],["delete","document.remove"]],"/api/v1/submit/url":["post","submit.url"],"/api/v1/submit/string":["post","submit.string"],"/api/v1/submit/html_string":["post","submit.html_string"],
"/":["get","home"],"/blog":["get","blog"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();
