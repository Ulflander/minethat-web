(function(){var a=process.env.ENV,b,e=require("fs"),d=require("tracer").console({format:["{{timestamp}} <{{title}}> {{message}}",{error:"{{timestamp}} <{{title}}> {{message}} (in {{file}}:{{line}})\nCall Stack:\n{{stack}}"}],transport:function(a){5===a.level?console.error(a.output):console.log(a.output)}}),f={loaded:!1,logger:d,env:a};"string"!==typeof a&&(d.error('No environment variable "ENV(test|local|development|production)"'),process.exit(1));b=__dirname+"/../../../conf/conf."+a+".sh";exports.parseLine=
function(a){0!==a.indexOf("#")&&0<a.indexOf("=")&&(a=a.split("="),f[a[0]]=/^[0-9]+$/ig.test(a[1])?parseInt(a[1],10):a[1])};exports.parse=function(a){a=a.split("\n");var c,g=a.length;for(c=0;c<g;c+=1)exports.parseLine(a[c])};exports.read=function(a){f.loaded=!0;e.readFile(b,function(c,g){c&&(d.error("No way to load conf",c),process.exit(1));exports.parse(g.toString());"function"===typeof a&&a(f)});return f};exports.conf=function(a){return f.loaded?f:exports.read(a)}})();(function(){require("./conf.js").conf(function(a){require("./server.js").run(a)})})();(function(){var a=require("connect"),b=require("serve-static"),e=require("body-parser"),d=require("./lib/init.js").initialize,f=require("./routes/router.js").router,h=require("./controllers/404.js"),c;exports.run=function(g){c=a();c.conf=g;c.logger=g.logger;c.use(require("./lib/auth.js").auth);c.use(b(__dirname+"/../../dist"));c.use(e());c.use(d);c.use(f());c.use(h.index);c.listen(g.WEB_SERVER_PORT);c.logger.log("Server started on "+g.WEB_SERVER_HOST+":"+g.WEB_SERVER_PORT)}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,e,d){a.view(b,e,"404.html")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,e,d){a.findAll(b,e,"Document",null,null,null,"document/list.html")};exports.display=function(b,e,d){a.find(b,e,"Document","document/display.html")};exports.remove=function(b,e,d){a.remove(b,e,"Document")}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/valid.js"),e=require("../lib/mail.js"),d=require("url"),f=require("ua-parser-js"),h=require("../routes/campaigns.js").campaigns;exports.campaign=function(c){var g={ref_campaign:"None",ref_domain:"Unknown"};c.query&&c.query.r&&(g.ref_campaign=h[c.query.r]||c.query.r);c.headers.referer&&(g.ref_domain=d.parse(c.headers.referer).hostname,0===g.ref_domain.indexOf("www.")&&(g.ref_domain=g.ref_domain.substr(4)));return g};exports.index=
function(c,g,d){a.view(c,g,"landing/landing.html",exports.campaign(c))};exports.subscribe=function(c,g,a){a=c.model("Subscriber");if(!c.body||!c.body.email)return g.json({error:"miss_param"},500);if(!b.email(c.body.email))return g.json({error:"invalid_email"},500);a.findOne({email:c.body.email},function(a,d){if(a)return g.json({error:"db_check_failed"},500);if(d)return g.json({status:"exists",id:d._id},200);exports.create(c,g)})};exports.create=function(c,a){var d=c.model("Subscriber"),b=(new f).setUA(c.headers["user-agent"]).getResult()||
{},h=new d({email:c.body.email,ref_campaign:c.body.ref_campaign,ref_domain:c.body.ref_domain,browser:b.browser&&b.browser.name?b.browser.name:"Unknown",os:b.os&&b.os.name?b.os.name:"Unknown",device:b.device&&b.device.vendor?b.device.vendor+" / "+(b.device.model||"Unknown"):"Unknown"});h.save(function(d){if(d)return a.json({error:"db_save_failed"},500);e.template(c.body.email,"You're in!","landing-subscribed.html",{sub:h});a.json({status:"success"})})}})();(function(){var a=require("../lib/controller-view.js"),b=require("../lib/internet.js");exports.index=function(b,d,f){a.findAll(b,d,"Source",null,null,null,"source/list.html")};exports.display=function(b,d,f){a.find(b,d,"Source","source/edit.html")};exports.from_feed=function(e,d,f){"GET"===e.method?a.view(e,d,"source/from_feed.html"):b.feed(e.body.feed_url,function(b,c){b||!c?a.view(e,d,"source/from_feed.html",{error:"Invalid feed"}):(e.body.name=c.metadata.title,e.body.url=c.metadata.url,exports.add(e,
d,f))})};exports.add=function(b,d,f){a.create(b,d,"Source","source/edit.html","/app/source/:id")};exports.edit=function(b,d,f){a.edit(b,d,"Source","source/edit.html")};exports.remove=function(b,d,f){a.remove(b,d,"Source")}})();(function(){var a=require("../lib/controller-view.js");exports.index=function(b,e){var d=b.model("Subscriber");if(!b.query.id)return e.error("Missing param for unsubscription",500);d.findById(b.query.id,function(d,h){var c=null;if(d)return e.error("DB query error",500);b.query.action&&("unsubscribe"===b.query.action?(h.unactivated=!0,c="Done! You won't receive our newsletter anymore."):(h.unactivated=!1,c="Thanks! You're now subscribed to our newsletter!"),h.save());a.view(b,e,"subscribers/subscription.html",
{msg:c,sub:h})})}})();(function(){var a=require("http-auth").basic({authRealm:"Private Minethat",file:__dirname+"/../../../users.htpasswd"});exports.auth=function(b,e,d){0===b._parsedUrl.href.indexOf("/private")||0===b._parsedUrl.href.indexOf("/admin")||0===b._parsedUrl.href.indexOf("/app")?a.check(b,e,function(a){d()}):d()}})();(function(){var a=require("ejs"),b=require("fs"),e=require("async"),d=require("../conf.js").conf(),f=/<%-\s+partial\s*\(\s*['"]([a-zA-Z0-9\\\-_]+)['"]/ig,h={};exports.remove=function(c,a,b,d){c.isAPI?c.model(b).findById(c.params.id,function(c,b){c||null===b?a.json({status:"error",error:"Resource not found"},404):b.remove(function(c){c?a.json({status:"error",error:"Resource not deleted"},500):a.json({status:"success"},200)})}):a.error(404,"Only available through API")};exports.save=function(c,a,b,
d,f){var e=new (c.model(b))(c.body),h=!1;e.save(function(b){var k={status:b?"success":"error",doc:e.toObject()};h||(h=!0,b&&(k.error={message:b}),c.isAPI?a.json(k,b?500:200):f?a.redirect(f.split(":id").join(e._id)):exports.view(c,a,d,k))})};exports.create=function(c,a,b,d,f){var e=c.model(b);"POST"===c.method?exports.save(c,a,b,d,f):c.isAPI?a.json({error:"Not implemented"},500):exports.view(c,a,d,{doc:new e,status:"create"})};exports.find=function(c,a,b,d){c.find(b,c.params.id,function(b,f){if(b)return a.error(500);
f?c.isAPI?a.json(f):exports.view(c,a,d,{doc:f,status:"exists"}):c.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})};exports.edit=function(c,a,b,d){"GET"===c.method?exports.find(c,a,b,d):c.model(b).update({_id:c.params.id},c.body,function(f,e,h){if(f)return a.error(500);c.find(b,c.params.id,function(b,f){if(b)return a.error(500);f?c.isAPI?a.json(f):exports.view(c,a,d,{doc:f,status:"exists"}):c.isAPI?a.json({status:"error",error:"Resource not found"},404):a.error(404)})})};
exports.findAll=function(c,a,b,d,f,e,h){c.findAll(c,b,d,f,e,function(b,d){if(b)return a.error(404);c.isAPI?a.json(d):exports.view(c,a,h,d)})};exports.requiresLoading=function(c){return!h[c]||"production"!==d.env};exports.load=function(c,a){b.readFile(__dirname+"/../views/"+c,function(b,f){b?(d.logger.error("File not found: views/"+c),h[c]="Template not found"):h[c]=f.toString();var e=exports.detectPartials(c);0<e.length?exports.loadPartials(e,a):"function"===typeof a&&a()})};exports.render=function(c,
b){return a.render(h[c],{data:b?b:{},partial:exports.partial})};exports.view=function(c,a,b,d){exports.renderView(b,d,function(c){a.html(c)})};exports.renderView=function(c,a,b){var d=function(){b(exports.render(c,a))};if(exports.requiresLoading(c))return exports.load(c,d);d()};exports.partial=function(c,b){return a.render(h["_partials/"+c+".html"],b)};exports.loadPartials=function(c,a){var b,d=c.length,f=[];for(b=0;b<d;b+=1)f.push(exports.loadPartial(c[b]));e.parallel(f,a)};exports.loadPartial=function(a){return function(b){exports.load("_partials/"+
a+".html",b)}};exports.detectPartials=function(a){for(var b=[],d;;){d=f.exec(h[a]);if(!d)break;b.push(d[1])}return b}})();(function(){var a=require("../conf.js").conf(),b=require("./respond.js"),e=require("./models.js"),d=require("qs");exports.initialize=function(f,h,c){var g;f.logger=a.logger;f.query=d.parse(f._parsedUrl.query);for(g in e)e.hasOwnProperty(g)&&(f[g]?a.logger.error("Injection failed: key "+g+"already defined in Request object"):f[g]=e[g]);for(g in b)b.hasOwnProperty(g)&&(h[g]?a.logger.error("Injection failed: key "+g+"already defined in Response object"):h[g]=b[g]);c()}})();(function(){var a=require("request"),b=require("blindparser");exports.get=function(b,d){a(b,function(a,b){a||200!==b.statusCode?d(a):d(null,b.body,b.href)})};exports.feed=function(a,d){exports.get(a,function(a,e,c){a?d(a):b.parseString(e,{},function(a,c){a?d(a):d(null,c)})})}})();(function(){var a,b=require("html-to-text"),e=require("./controller-view.js"),d=require("../conf.js").conf(),f=d.logger,h=require("nodemailer");exports.html=function(c,e,k,l,m){a||(a=h.createTransport("SMTP",{service:"Gmail",auth:{user:d.WEB_EMAIL_USER,pass:d.WEB_EMAIL_PASS}}));a.sendMail({from:l||"Xav from Minethat <xav@minethat.co>",to:c,subject:e,text:m||b.fromString(k),html:k},function(a,c){a?f.error(a):f.debug("Message sent: "+c.message)})};exports.template=function(a,b,d,f,h,n){e.renderView("emails/"+
d,f,function(d){exports.html(a,b,d,h,n)})}})();(function(){var a={},b=require("../conf.js").conf().logger,e=require("mongoose");e.connect("mongodb://localhost/minethat_local");exports.loadModel=function(b){a[b]=require("../models/"+b.toLowerCase()+".js").define(e)};exports.model=function(b){a[b]||exports.loadModel(b);return a[b]};exports.find=function(a,f,e){"string"===typeof a&&(a=exports.model(a));a.findById(f,function(a,d){a&&b.error("Error querying db",a);"function"===typeof e&&e(a,d)})};exports.findAll=function(a,f,e,c,g,k){var l=a.query?
parseInt(a.query.page,10)||1:1;"string"===typeof f&&(f=exports.model(f));f.count({},function(a,d){a&&b.error("Error querying db",a);f.find(e||{},c||{},exports.page(l,g),function(a,c){a&&b.error("Error querying db",a);"function"===typeof k&&k(a,{docs:c,total:d,limit:20,page:l,hasNext:20*l<d,hasPrevious:1<l})})})};exports.page=function(a,b){var e,c;e={skip:20*(a-1),limit:20};if(b)for(c in b)b.hasOwnProperty(c)&&(e[c]=b[c]);return e}})();(function(){exports.error=function(a){this.respond(a||404,"text/plain","File not found")};exports.html=function(a,b){this.respond(b||200,"text/html",a)};exports.plain=function(a,b){this.respond(b||200,"text/plain",a)};exports.json=function(a,b){this.respond(b||200,"application/json","string"===typeof a?a:JSON.stringify(a))};exports.respond=function(a,b,e){this.writeHead(a,{"Content-type":b});this.end(e)};exports.redirect=function(a){this.writeHead(302,{Location:a});this.end()}})();(function(){exports.email=function(a){var b,e;if(!a||"string"!==typeof a)return!1;b=a.indexOf("@");e=a.lastIndexOf(".");return 0<b&&3<e&&b<e&&a.length>e+2}})();(function(){exports.define=function(a){return a.model("Document",new a.Schema({rawLength:Number,raw:String}))}})();(function(){exports.define=function(a){return a.model("Job",new a.Schema({start:{type:Date,"default":Date.now},end:Date,status:String,gateway:String,value:String,type:String,document:String,customerId:{type:String,index:!0},meta:{url:String,title:String,author:String,organization:String},email:String,target:{type:String,"default":"MINE"},classes:String}))}})();(function(){var a=require("../lib/internet.js");exports.define=function(b){var e=new b.Schema({name:String,url:String,feed_url:{type:String,index:!0},type:{type:String,"default":"CONTENT"},customer_id:{type:String,index:!0},last_timestamp:{type:Number}});b=b.model("Source",e);e.pre("save",function(b){var f=this,e=!1,c=0,g=function(a){a&&(e=!0);c+=1;2===c&&b(e?Error("Validation error"):null)};a.get(this.url,function(a,b,c){a&&f.invalidate("url","URL is invalid");g(a)});a.feed(this.feed_url,function(a,
b,c){a&&f.invalidate("url","Feed URL is invalid");g(a)})});return b}})();(function(){exports.define=function(a){return a.model("Subscriber",new a.Schema({email:String,ref_campaign:String,ref_domain:String,os:String,device:String,browser:String,ts_created:{type:Date,"default":Date.now},unactivated:{type:Boolean,"default":!1}}))}})();(function(){exports.campaigns={r1:"Reddit landing feedback",t1:"Twitter link",e1:"Xav email footer"}})();(function(){var a=require("./routes.js").routes,b={},e=require("urlrouter");exports.setup=function(a,b,e,c,g){if("function"!==typeof c[g])throw Error('Route "'+e+'" is invalid:  function "'+g+'" does not exist in controller.');a[b](e,function(a,b,d){0===e.indexOf("/api")?a.isAPI=!0:a.isAPI=!1;c[g](a,b,d)})};exports.route=function(a,e,h){var c=h[1].split(".");b[c[0]]||(b[c[0]]=require("../controllers/"+c[0]+".js"));2>c.length&&(c[1]="index");exports.setup(a,h[0],e,b[c[0]],c[1])};exports.apply=function(b){var e,
h,c;for(e in a)if(a.hasOwnProperty(e))if("string"===typeof a[e][0])exports.route(b,e,a[e]);else for(h=0,c=a[e].length;h<c;h+=1)exports.route(b,e,a[e][h])};exports.router=function(){return e(exports.apply)}})();(function(){exports.routes={"/app/sources":["get","source.index"],"/app/source/new":[["get","source.add"],["post","source.add"]],"/app/source/generate":[["get","source.from_feed"],["post","source.from_feed"]],"/app/source/:id":[["get","source.edit"],["post","source.edit"]],"/app/documents":["get","document.index"],"/app/document/:id":["get","document.display"],"/api/v1/sources":["get","source.index"],"/api/v1/source/:id":[["get","source.display"],["post","source.edit"],["delete","source.remove"]],
"/api/v1/source":["post","source.add"],"/":["get","home"],"/ajax/landing_subscribe":["post","home.subscribe"],"/subscription":["get","subscription"]}})();
